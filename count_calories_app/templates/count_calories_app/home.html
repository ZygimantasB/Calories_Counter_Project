{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Calories Counter{% endblock %}

{% block css_files %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'count_calories_app/count_calories_app.css' %}">
  <style>
    .stat-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: none;
      border-radius: 12px;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .quick-action-btn {
      transition: all 0.2s ease;
      border-radius: 10px;
      padding: 1rem;
      text-decoration: none;
      border: 2px solid transparent;
    }
    .quick-action-btn:hover {
      transform: translateY(-2px);
      border-color: currentColor;
    }
    .tracker-card {
      border-radius: 12px;
      border: none;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .tracker-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12) !important;
    }
    .tracker-card .card-header {
      border-bottom: none;
      padding: 1rem 1.25rem;
    }
    .gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .gradient-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .gradient-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .gradient-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
    .gradient-dark { background: linear-gradient(135deg, #232526 0%, #414345 100%); }
    .gradient-orange { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }
    .gradient-purple { background: linear-gradient(135deg, #7f00ff 0%, #e100ff 100%); }
    .recent-food-item {
      border-left: 3px solid #667eea;
      transition: background-color 0.2s ease;
    }
    .recent-food-item:hover {
      background-color: #f8f9fa;
    }
    .streak-badge {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .section-title {
      font-weight: 600;
      color: #2d3436;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-title i {
      color: #667eea;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header Section -->
  <div class="py-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h1 class="h2 fw-bold mb-1">Dashboard</h1>
        <p class="text-muted mb-0">{{ current_date|date:"l, F j, Y" }}</p>
      </div>
      <div class="d-flex gap-2 mt-2 mt-md-0">
        <a href="{% url 'food_tracker' %}?range=today" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i> Log Food
        </a>
        <a href="{% url 'analytics' %}" class="btn btn-outline-primary">
          <i class="fas fa-chart-line me-1"></i> Analytics
        </a>
      </div>
    </div>
  </div>

  <!-- Today's Stats Row -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="card stat-card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stat-icon gradient-danger text-white me-3">
              <i class="fas fa-fire"></i>
            </div>
            <div>
              <div class="text-muted small">Today's Calories</div>
              <div class="h4 mb-0 fw-bold">{{ today_stats.calories|floatformat:0 }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card stat-card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stat-icon gradient-info text-white me-3">
              <i class="fas fa-drumstick-bite"></i>
            </div>
            <div>
              <div class="text-muted small">Protein</div>
              <div class="h4 mb-0 fw-bold">{{ today_stats.protein|floatformat:1 }}g</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card stat-card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stat-icon gradient-warning text-white me-3">
              <i class="fas fa-bread-slice"></i>
            </div>
            <div>
              <div class="text-muted small">Carbs</div>
              <div class="h4 mb-0 fw-bold">{{ today_stats.carbs|floatformat:1 }}g</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card stat-card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stat-icon gradient-orange text-white me-3">
              <i class="fas fa-cheese"></i>
            </div>
            <div>
              <div class="text-muted small">Fat</div>
              <div class="h4 mb-0 fw-bold">{{ today_stats.fat|floatformat:1 }}g</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fitness Goal Selector -->
  <div class="card shadow-sm mb-4" style="border-radius: 12px; border: none;">
    <div class="card-body py-3">
      <div class="d-flex align-items-center gap-2 mb-3">
        <i class="fas fa-bullseye text-primary"></i>
        <span class="fw-semibold">Fitness Goal</span>
        {% if is_auto_macros %}
          <span class="badge bg-light text-muted ms-auto">Auto-calculated macros</span>
        {% endif %}
      </div>
      <div class="row g-2">
        <div class="col-6 col-md-3">
          <button type="button" class="btn w-100 goal-btn {% if fitness_goal == 'maintain' %}btn-primary{% else %}btn-outline-secondary{% endif %}" data-goal="maintain">
            <i class="fas fa-balance-scale me-1"></i> Maintain
          </button>
        </div>
        <div class="col-6 col-md-3">
          <button type="button" class="btn w-100 goal-btn {% if fitness_goal == 'bulk' %}btn-success{% else %}btn-outline-secondary{% endif %}" data-goal="bulk">
            <i class="fas fa-dumbbell me-1"></i> Gain Mass
          </button>
        </div>
        <div class="col-6 col-md-3">
          <button type="button" class="btn w-100 goal-btn {% if fitness_goal == 'cut' %}btn-warning{% else %}btn-outline-secondary{% endif %}" data-goal="cut">
            <i class="fas fa-fire me-1"></i> Lose Fat
          </button>
        </div>
        <div class="col-6 col-md-3">
          <button type="button" class="btn w-100 goal-btn {% if fitness_goal == 'ripped' %}btn-danger{% else %}btn-outline-secondary{% endif %}" data-goal="ripped">
            <i class="fas fa-bolt me-1"></i> Get Ripped
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Macro Progress Section -->
  <div class="card shadow-sm mb-4" style="border-radius: 12px; border: none;">
    <div class="card-header bg-white border-0 pt-4 pb-2">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="section-title mb-0">
          <i class="fas fa-chart-pie"></i> Today's Nutrition Progress
        </h5>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-4">
        <!-- Calories Progress -->
        <div class="col-md-6 col-lg-3">
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <span class="fw-semibold"><i class="fas fa-fire text-danger me-1"></i> Calories</span>
            <span class="{% if macro_progress.calories.exceeded %}text-danger fw-bold{% else %}text-muted{% endif %}">
              {% if macro_progress.calories.exceeded %}
                {{ macro_progress.calories.percentage }}% of target
              {% else %}
                {{ macro_progress.calories.remaining|floatformat:0 }} left
              {% endif %}
            </span>
          </div>
          <div class="progress" style="height: 12px; border-radius: 6px;">
            <div class="progress-bar {% if macro_progress.calories.percentage > 100 %}bg-danger{% elif macro_progress.calories.percentage > 90 %}bg-warning{% else %}bg-success{% endif %}"
                 role="progressbar"
                 style="width: {% if macro_progress.calories.percentage > 100 %}100{% else %}{{ macro_progress.calories.percentage }}{% endif %}%">
            </div>
          </div>
          <div class="mt-1 small text-muted">
            {{ macro_progress.calories.current|floatformat:0 }} / {{ macro_progress.calories.target }} kcal
          </div>
        </div>

        <!-- Protein Progress -->
        <div class="col-md-6 col-lg-3">
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <span class="fw-semibold"><i class="fas fa-drumstick-bite text-info me-1"></i> Protein</span>
            <span class="{% if macro_progress.protein.exceeded %}text-info fw-bold{% else %}text-muted{% endif %}">
              {% if macro_progress.protein.exceeded %}
                {{ macro_progress.protein.percentage }}% of target
              {% else %}
                {{ macro_progress.protein.remaining|floatformat:0 }}g left
              {% endif %}
            </span>
          </div>
          <div class="progress" style="height: 12px; border-radius: 6px;">
            <div class="progress-bar bg-info"
                 role="progressbar"
                 style="width: {% if macro_progress.protein.percentage > 100 %}100{% else %}{{ macro_progress.protein.percentage }}{% endif %}%">
            </div>
          </div>
          <div class="mt-1 small text-muted">
            {{ macro_progress.protein.current|floatformat:0 }} / {{ macro_progress.protein.target }}g
          </div>
        </div>

        <!-- Carbs Progress -->
        <div class="col-md-6 col-lg-3">
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <span class="fw-semibold"><i class="fas fa-bread-slice text-warning me-1"></i> Carbs</span>
            <span class="{% if macro_progress.carbs.exceeded %}text-danger fw-bold{% else %}text-muted{% endif %}">
              {% if macro_progress.carbs.exceeded %}
                {{ macro_progress.carbs.percentage }}% of target
              {% else %}
                {{ macro_progress.carbs.remaining|floatformat:0 }}g left
              {% endif %}
            </span>
          </div>
          <div class="progress" style="height: 12px; border-radius: 6px;">
            <div class="progress-bar {% if macro_progress.carbs.percentage > 100 %}bg-danger{% elif macro_progress.carbs.percentage > 90 %}bg-warning{% else %}bg-warning{% endif %}"
                 role="progressbar"
                 style="width: {% if macro_progress.carbs.percentage > 100 %}100{% else %}{{ macro_progress.carbs.percentage }}{% endif %}%">
            </div>
          </div>
          <div class="mt-1 small text-muted">
            {{ macro_progress.carbs.current|floatformat:0 }} / {{ macro_progress.carbs.target }}g
          </div>
        </div>

        <!-- Fat Progress -->
        <div class="col-md-6 col-lg-3">
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <span class="fw-semibold"><i class="fas fa-cheese text-secondary me-1"></i> Fat</span>
            <span class="{% if macro_progress.fat.exceeded %}text-danger fw-bold{% else %}text-muted{% endif %}">
              {% if macro_progress.fat.exceeded %}
                {{ macro_progress.fat.percentage }}% of target
              {% else %}
                {{ macro_progress.fat.remaining|floatformat:0 }}g left
              {% endif %}
            </span>
          </div>
          <div class="progress" style="height: 12px; border-radius: 6px;">
            <div class="progress-bar {% if macro_progress.fat.percentage > 100 %}bg-danger{% elif macro_progress.fat.percentage > 90 %}bg-warning{% else %}bg-secondary{% endif %}"
                 role="progressbar"
                 style="width: {% if macro_progress.fat.percentage > 100 %}100{% else %}{{ macro_progress.fat.percentage }}{% endif %}%">
            </div>
          </div>
          <div class="mt-1 small text-muted">
            {{ macro_progress.fat.current|floatformat:0 }} / {{ macro_progress.fat.target }}g
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Secondary Stats Row -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card stat-card shadow-sm h-100 text-center">
        <div class="card-body py-3">
          <div class="streak-badge">{{ streak }}</div>
          <div class="text-muted small">Day Streak</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card stat-card shadow-sm h-100 text-center">
        <div class="card-body py-3">
          <div class="h3 mb-0 fw-bold text-primary">{{ today_stats.count }}</div>
          <div class="text-muted small">Meals Today</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card stat-card shadow-sm h-100 text-center">
        <div class="card-body py-3">
          {% if latest_weight %}
            <div class="h3 mb-0 fw-bold text-success">{{ latest_weight.weight }}kg</div>
          {% else %}
            <div class="h3 mb-0 fw-bold text-muted">--</div>
          {% endif %}
          <div class="text-muted small">Current Weight</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card stat-card shadow-sm h-100 text-center">
        <div class="card-body py-3">
          {% if weight_change is not None %}
            <div class="h3 mb-0 fw-bold {% if weight_change < 0 %}text-success{% elif weight_change > 0 %}text-danger{% else %}text-muted{% endif %}">
              {% if weight_change > 0 %}+{% endif %}{{ weight_change|floatformat:1 }}kg
            </div>
          {% else %}
            <div class="h3 mb-0 fw-bold text-muted">--</div>
          {% endif %}
          <div class="text-muted small">7-Day Change</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card stat-card shadow-sm h-100 text-center">
        <div class="card-body py-3">
          <div class="h3 mb-0 fw-bold text-secondary">{{ week_workouts }}</div>
          <div class="text-muted small">Workouts This Week</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card stat-card shadow-sm h-100 text-center">
        <div class="card-body py-3">
          <div class="h3 mb-0 fw-bold text-warning">{{ week_run_stats.distance|floatformat:1 }}km</div>
          <div class="text-muted small">Running This Week</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">
      <!-- This Week Summary -->
      <div class="card shadow-sm mb-4" style="border-radius: 12px; border: none;">
        <div class="card-header bg-white border-0 pt-4 pb-0">
          <h5 class="section-title mb-0"><i class="fas fa-calendar-week"></i> This Week Summary</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-3">
              <div class="h4 fw-bold text-danger mb-1">{{ week_stats.calories|floatformat:0 }}</div>
              <small class="text-muted">Total Calories</small>
            </div>
            <div class="col-3">
              <div class="h4 fw-bold text-info mb-1">{{ week_stats.protein|floatformat:0 }}g</div>
              <small class="text-muted">Protein</small>
            </div>
            <div class="col-3">
              <div class="h4 fw-bold text-warning mb-1">{{ week_stats.carbs|floatformat:0 }}g</div>
              <small class="text-muted">Carbs</small>
            </div>
            <div class="col-3">
              <div class="h4 fw-bold text-secondary mb-1">{{ week_stats.count }}</div>
              <small class="text-muted">Meals Logged</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Trackers Grid -->
      <h5 class="section-title"><i class="fas fa-th-large"></i> Quick Access</h5>
      <div class="row g-3 mb-4">
        <!-- Food Tracker -->
        <div class="col-md-6">
          <div class="card tracker-card shadow-sm h-100">
            <div class="card-header gradient-primary text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><i class="fas fa-utensils me-2"></i>Food Tracker</h6>
                </div>
                <a href="{% url 'food_tracker' %}" class="btn btn-sm btn-light">Open</a>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">AI-powered meal logging with nutrition analysis</p>
              <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'food_tracker' %}?range=today" class="btn btn-sm btn-outline-primary">Today</a>
                <a href="{% url 'food_tracker' %}?range=week" class="btn btn-sm btn-outline-primary">This Week</a>
                <a href="{% url 'food_tracker' %}?range=today&export=csv" class="btn btn-sm btn-outline-warning">Export CSV</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Foods -->
        <div class="col-md-6">
          <div class="card tracker-card shadow-sm h-100">
            <div class="card-header gradient-info text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><i class="fas fa-trophy me-2"></i>Top Foods</h6>
                </div>
                <a href="{% url 'top_foods' %}" class="btn btn-sm btn-light">Open</a>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">Search, analyze and track your most eaten foods</p>
              <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'top_foods' %}?days=30" class="btn btn-sm btn-outline-info">30 Days</a>
                <a href="{% url 'top_foods' %}?days=all" class="btn btn-sm btn-outline-info">All Time</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Weight Tracker -->
        <div class="col-md-6">
          <div class="card tracker-card shadow-sm h-100">
            <div class="card-header gradient-success text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><i class="fas fa-weight me-2"></i>Weight Tracker</h6>
                </div>
                <a href="{% url 'weight_tracker' %}" class="btn btn-sm btn-light">Open</a>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">Track weight with charts, stats and goal projections</p>
              <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'weight_tracker' %}?days=90" class="btn btn-sm btn-outline-success">Last 90 Days</a>
                <a href="{% url 'weight_tracker' %}?export=csv" class="btn btn-sm btn-outline-warning">Export CSV</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics -->
        <div class="col-md-6">
          <div class="card tracker-card shadow-sm h-100">
            <div class="card-header gradient-purple text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><i class="fas fa-chart-line me-2"></i>Analytics</h6>
                </div>
                <a href="{% url 'analytics' %}" class="btn btn-sm btn-light">Open</a>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">Advanced insights, trends, and detailed reports</p>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-light text-dark">Meal Timing</span>
                <span class="badge bg-light text-dark">Nutrition Score</span>
                <span class="badge bg-light text-dark">Achievements</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Workouts -->
        <div class="col-md-6">
          <div class="card tracker-card shadow-sm h-100">
            <div class="card-header gradient-dark text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><i class="fas fa-dumbbell me-2"></i>Workouts</h6>
                </div>
                <a href="{% url 'workout_tracker' %}" class="btn btn-sm btn-light">Open</a>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">Log sessions, exercises, sets, reps and weights</p>
              <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'workout_tracker' %}" class="btn btn-sm btn-outline-secondary">Sessions</a>
                <a href="{% url 'workout_table' %}" class="btn btn-sm btn-outline-secondary">Tables</a>
                <a href="{% url 'exercise_list' %}" class="btn btn-sm btn-outline-secondary">Exercises</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Running -->
        <div class="col-md-6">
          <div class="card tracker-card shadow-sm h-100">
            <div class="card-header gradient-orange text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><i class="fas fa-running me-2"></i>Running</h6>
                </div>
                <a href="{% url 'running_tracker' %}" class="btn btn-sm btn-light">Open</a>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">Track distance, duration and running progress</p>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-light text-dark">{{ week_run_stats.count }} runs this week</span>
                <span class="badge bg-light text-dark">{{ week_run_stats.distance|floatformat:1 }}km total</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Body Measurements -->
        <div class="col-md-6">
          <div class="card tracker-card shadow-sm h-100">
            <div class="card-header gradient-danger text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><i class="fas fa-ruler me-2"></i>Body Measurements</h6>
                </div>
                <a href="{% url 'body_measurements_tracker' %}" class="btn btn-sm btn-light">Open</a>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">Track neck, chest, waist, arms, legs and more</p>
              <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'body_measurements_tracker' %}" class="btn btn-sm btn-outline-danger">View All</a>
                <a href="{% url 'export_body_measurements_csv' %}" class="btn btn-sm btn-outline-warning">Export CSV</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
      <!-- Weight Prediction -->
      {% if weight_prediction %}
      <div class="card shadow-sm mb-4" style="border-radius: 12px; border: none; border-left: 4px solid {% if weight_prediction.is_surplus %}#dc3545{% else %}#198754{% endif %} !important;">
        <div class="card-header bg-white border-0 pt-3 pb-0">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="section-title mb-0">
              <i class="fas fa-weight me-2 {% if weight_prediction.is_surplus %}text-danger{% else %}text-success{% endif %}"></i>Weight Projection
            </h5>
            <small class="text-muted">based on this week</small>
          </div>
        </div>
        <div class="card-body pt-2 pb-3">

          <!-- TDEE vs actual -->
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded"
               style="background:{% if weight_prediction.is_surplus %}rgba(220,53,69,.07){% else %}rgba(25,135,84,.07){% endif %}">
            <div class="small text-muted">
              Avg this week vs TDEE
            </div>
            <div class="fw-bold {% if weight_prediction.is_surplus %}text-danger{% else %}text-success{% endif %}">
              {% if weight_prediction.is_surplus %}+{% endif %}{{ weight_prediction.daily_delta }} kcal/day
            </div>
          </div>
          <div class="d-flex justify-content-between small text-muted mb-3 px-1">
            <span>Avg eaten: <strong>{{ weight_prediction.avg_daily_cal }} kcal</strong></span>
            <span>TDEE: <strong>{{ weight_prediction.tdee }} kcal</strong></span>
          </div>

          <!-- Projections -->
          <div class="row g-2 text-center">
            <div class="col-4">
              <div class="rounded p-2" style="background:var(--bs-light,#f8f9fa);">
                <div class="small text-muted">4 weeks</div>
                <div class="fw-bold {% if weight_prediction.week_4 < weight_prediction.current_weight %}text-success{% elif weight_prediction.week_4 > weight_prediction.current_weight %}text-danger{% else %}text-muted{% endif %}">
                  {{ weight_prediction.week_4 }} kg
                </div>
              </div>
            </div>
            <div class="col-4">
              <div class="rounded p-2" style="background:var(--bs-light,#f8f9fa);">
                <div class="small text-muted">8 weeks</div>
                <div class="fw-bold {% if weight_prediction.week_8 < weight_prediction.current_weight %}text-success{% elif weight_prediction.week_8 > weight_prediction.current_weight %}text-danger{% else %}text-muted{% endif %}">
                  {{ weight_prediction.week_8 }} kg
                </div>
              </div>
            </div>
            <div class="col-4">
              <div class="rounded p-2" style="background:var(--bs-light,#f8f9fa);">
                <div class="small text-muted">12 weeks</div>
                <div class="fw-bold {% if weight_prediction.week_12 < weight_prediction.current_weight %}text-success{% elif weight_prediction.week_12 > weight_prediction.current_weight %}text-danger{% else %}text-muted{% endif %}">
                  {{ weight_prediction.week_12 }} kg
                </div>
              </div>
            </div>
          </div>

          <div class="text-center mt-2">
            <small class="text-muted">
              Now: {{ weight_prediction.current_weight }} kg
              &nbsp;·&nbsp;
              {% if weight_prediction.weekly_kg < 0 %}
                losing ~{{ weight_prediction.weekly_kg|stringformat:".2f"|slice:"1:" }} kg/week
              {% elif weight_prediction.weekly_kg > 0 %}
                gaining ~{{ weight_prediction.weekly_kg }} kg/week
              {% else %}
                maintaining weight
              {% endif %}
              &nbsp;·&nbsp; {{ weight_prediction.days_used }}-day avg
            </small>
          </div>

        </div>
      </div>
      {% endif %}

      <!-- Recent Foods -->
      <div class="card shadow-sm mb-4" style="border-radius: 12px; border: none;">
        <div class="card-header bg-white border-0 pt-4 pb-2">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="section-title mb-0"><i class="fas fa-history"></i> Recent Foods</h5>
            <a href="{% url 'food_tracker' %}?range=today" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
        </div>
        <div class="card-body pt-0">
          {% if recent_foods %}
            <div class="list-group list-group-flush">
              {% for food in recent_foods %}
                <div class="list-group-item recent-food-item px-3 py-2 border-0">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold text-truncate" style="max-width: 180px;">{{ food.product_name }}</div>
                      <small class="text-muted">{{ food.consumed_at|date:"M j, g:i A" }}</small>
                    </div>
                    <div class="text-end">
                      <div class="fw-bold text-danger">{{ food.calories|floatformat:0 }}</div>
                      <small class="text-muted">kcal</small>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="fas fa-utensils fa-2x mb-2 opacity-50"></i>
              <p class="mb-0">No foods logged yet</p>
              <a href="{% url 'food_tracker' %}" class="btn btn-sm btn-primary mt-2">Log your first meal</a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Tips -->
      <div class="card shadow-sm" style="border-radius: 12px; border: none;">
        <div class="card-header bg-white border-0 pt-4 pb-2">
          <h5 class="section-title mb-0"><i class="fas fa-lightbulb"></i> Quick Tips</h5>
        </div>
        <div class="card-body pt-0">
          <div class="d-flex align-items-start mb-3">
            <div class="stat-icon gradient-primary text-white me-3" style="width: 40px; height: 40px; font-size: 1rem;">
              <i class="fas fa-robot"></i>
            </div>
            <div>
              <div class="fw-semibold">AI Food Assistant</div>
              <small class="text-muted">Describe your meal in natural language and let AI auto-fill the nutrition info.</small>
            </div>
          </div>
          <div class="d-flex align-items-start mb-3">
            <div class="stat-icon gradient-success text-white me-3" style="width: 40px; height: 40px; font-size: 1rem;">
              <i class="fas fa-search"></i>
            </div>
            <div>
              <div class="fw-semibold">Search Top Foods</div>
              <small class="text-muted">Use the search in Top Foods to find specific items and see their total impact.</small>
            </div>
          </div>
          <div class="d-flex align-items-start">
            <div class="stat-icon gradient-warning text-white me-3" style="width: 40px; height: 40px; font-size: 1rem;">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div>
              <div class="fw-semibold">Check Analytics</div>
              <small class="text-muted">Visit Analytics for detailed insights, meal timing patterns, and achievements.</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_body %}
<script>
(function() {
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.querySelectorAll('.goal-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var goal = this.getAttribute('data-goal');
      fetch('{% url "api_update_fitness_goal" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({fitness_goal: goal})
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        if (data.success) {
          window.location.reload();
        }
      });
    });
  });
})();
</script>
{% endblock %}
