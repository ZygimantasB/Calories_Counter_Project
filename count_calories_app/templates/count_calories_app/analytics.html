{% extends "base.html" %}
{% load static %}

{% block title %}Analytics{% endblock %}

{% block css_files %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'count_calories_app/count_calories_app.css' %}">
  <style>
    .insight-card {
      border-left: 4px solid;
      transition: transform 0.2s;
    }
    .insight-card:hover {
      transform: translateX(5px);
    }
    .insight-card.calories { border-left-color: #dc3545; }
    .insight-card.protein { border-left-color: #198754; }
    .insight-card.carbs { border-left-color: #0d6efd; }
    .insight-card.fat { border-left-color: #ffc107; }
    .insight-card.weekend { border-left-color: #6f42c1; }
    .insight-card.consistency { border-left-color: #20c997; }
    .insight-card.streak { border-left-color: #fd7e14; }
    .insight-card.milestone { border-left-color: #d63384; }
    .insight-card.timing { border-left-color: #17a2b8; }
    .insight-card.distribution { border-left-color: #6610f2; }
    .achievement-badge {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--bg-secondary, #f8f9fa) 0%, var(--bg-tertiary, #e9ecef) 100%);
      min-width: 100px;
      transition: transform 0.2s;
    }
    .achievement-badge:hover {
      transform: scale(1.05);
    }
    .achievement-icon {
      font-size: 2rem;
      margin-bottom: 5px;
    }
    .timing-bar {
      height: 25px;
      border-radius: 4px;
      overflow: hidden;
      display: flex;
    }
    .timing-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.7rem;
      font-weight: bold;
      transition: all 0.3s;
    }
    .timing-segment:hover {
      filter: brightness(1.1);
    }
    .grade-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: white;
    }
    .grade-A { background: linear-gradient(135deg, #198754, #20c997); }
    .grade-B { background: linear-gradient(135deg, #0d6efd, #6ea8fe); }
    .grade-C { background: linear-gradient(135deg, #ffc107, #ffda6a); color: #000; }
    .grade-D { background: linear-gradient(135deg, #fd7e14, #ffc107); }
    .grade-F { background: linear-gradient(135deg, #dc3545, #f8d7da); }
    .stat-card {
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: scale(1.02);
    }
    .weight-change-positive { color: #dc3545; }
    .weight-change-negative { color: #198754; }
    .table-reports th {
      position: sticky;
      top: 0;
      background: var(--bg-secondary, #f8f9fa);
      z-index: 1;
    }
    .progress-ring {
      width: 120px;
      height: 120px;
    }
    .day-bar {
      height: 8px;
      border-radius: 4px;
      background: var(--bg-tertiary, #e9ecef);
      overflow: hidden;
    }
    .day-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .streak-badge {
      font-size: 2rem;
    }
    .macro-bar {
      height: 30px;
      border-radius: 5px;
      overflow: hidden;
      display: flex;
    }
    .macro-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="h3 mb-3">Analytics & Insights</h1>

      <!-- Analytics Navigation Tabs -->
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'analytics' %}{% if period %}?period={{ period }}{% endif %}">
            <i class="fas fa-chart-bar me-1"></i>Overview
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'month_compare' %}">
            <i class="fas fa-calendar-alt me-1"></i>Month Comparison
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'month_trends' %}">
            <i class="fas fa-chart-line me-1"></i>Yearly Trends
          </a>
        </li>
      </ul>

      <!-- Period Selection -->
      <div class="d-flex flex-wrap gap-2 mb-4">
        <a href="?period=30" class="btn btn-sm {% if period == '30' %}btn-primary{% else %}btn-outline-primary{% endif %}">Last 30 Days</a>
        <a href="?period=90" class="btn btn-sm {% if period == '90' %}btn-primary{% else %}btn-outline-primary{% endif %}">Last 90 Days</a>
        <a href="?period=180" class="btn btn-sm {% if period == '180' %}btn-primary{% else %}btn-outline-primary{% endif %}">Last 6 Months</a>
        <a href="?period=365" class="btn btn-sm {% if period == '365' %}btn-primary{% else %}btn-outline-primary{% endif %}">Last Year</a>
        <a href="?period=all" class="btn btn-sm {% if period == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">All Time</a>
      </div>
    </div>
  </div>

  <!-- THIS WEEK SUMMARY -->
  {% if weekly_summary %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body text-white">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4 mb-0"><i class="fas fa-calendar-week me-2"></i>This Week</h2>
            <span class="badge bg-light text-dark">{{ weekly_summary.this_week.days_logged }}/7 days logged</span>
          </div>

          <div class="row g-3">
            <!-- Avg Calories -->
            <div class="col-6 col-md-3">
              <div class="bg-white bg-opacity-10 rounded p-3 h-100">
                <div class="d-flex align-items-center mb-1">
                  <i class="fas fa-fire text-warning me-2"></i>
                  <small>Avg Calories</small>
                </div>
                <div class="h3 mb-0">{{ weekly_summary.this_week.avg_calories|floatformat:0 }}</div>
                {% if weekly_summary.comparison.calories_diff %}
                <small class="{% if weekly_summary.comparison.calories_diff > 0 %}text-warning{% else %}text-success{% endif %}">
                  {% if weekly_summary.comparison.calories_diff > 0 %}+{% endif %}{{ weekly_summary.comparison.calories_diff|floatformat:0 }} vs last week
                </small>
                {% endif %}
              </div>
            </div>

            <!-- Avg Protein -->
            <div class="col-6 col-md-3">
              <div class="bg-white bg-opacity-10 rounded p-3 h-100">
                <div class="d-flex align-items-center mb-1">
                  <i class="fas fa-drumstick-bite text-success me-2"></i>
                  <small>Avg Protein</small>
                </div>
                <div class="h3 mb-0">{{ weekly_summary.this_week.avg_protein|floatformat:0 }}g</div>
                {% if weekly_summary.comparison.protein_diff %}
                <small class="{% if weekly_summary.comparison.protein_diff > 0 %}text-success{% else %}text-warning{% endif %}">
                  {% if weekly_summary.comparison.protein_diff > 0 %}+{% endif %}{{ weekly_summary.comparison.protein_diff|floatformat:1 }}g vs last week
                </small>
                {% endif %}
              </div>
            </div>

            <!-- Workouts -->
            <div class="col-6 col-md-3">
              <div class="bg-white bg-opacity-10 rounded p-3 h-100">
                <div class="d-flex align-items-center mb-1">
                  <i class="fas fa-dumbbell text-info me-2"></i>
                  <small>Workouts</small>
                </div>
                <div class="h3 mb-0">{{ weekly_summary.this_week.workouts }}</div>
                {% if weekly_summary.comparison.workouts_diff != 0 %}
                <small class="{% if weekly_summary.comparison.workouts_diff > 0 %}text-success{% else %}text-warning{% endif %}">
                  {% if weekly_summary.comparison.workouts_diff > 0 %}+{% endif %}{{ weekly_summary.comparison.workouts_diff }} vs last week
                </small>
                {% else %}
                <small>Same as last week</small>
                {% endif %}
              </div>
            </div>

            <!-- Weight Change / Runs -->
            <div class="col-6 col-md-3">
              <div class="bg-white bg-opacity-10 rounded p-3 h-100">
                {% if weekly_summary.this_week.weight_change is not None %}
                <div class="d-flex align-items-center mb-1">
                  <i class="fas fa-weight text-danger me-2"></i>
                  <small>Weight Change</small>
                </div>
                <div class="h3 mb-0 {% if weekly_summary.this_week.weight_change < 0 %}text-success{% elif weekly_summary.this_week.weight_change > 0 %}text-warning{% endif %}">
                  {% if weekly_summary.this_week.weight_change > 0 %}+{% endif %}{{ weekly_summary.this_week.weight_change }} kg
                </div>
                {% if weekly_summary.this_week.current_weight %}
                <small>Current: {{ weekly_summary.this_week.current_weight|floatformat:1 }} kg</small>
                {% endif %}
                {% else %}
                <div class="d-flex align-items-center mb-1">
                  <i class="fas fa-running text-primary me-2"></i>
                  <small>Running</small>
                </div>
                <div class="h3 mb-0">{{ weekly_summary.this_week.runs }} runs</div>
                {% if weekly_summary.this_week.run_distance > 0 %}
                <small>{{ weekly_summary.this_week.run_distance }} km total</small>
                {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- GOAL PROGRESS -->
  {% if goal_progress %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h2 class="h5 mb-0"><i class="fas fa-bullseye me-2"></i>Weekly Goals Progress</h2>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <!-- Calories Goal -->
            {% if goal_progress.calories %}
            <div class="col-md-6 col-lg-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-fire text-warning me-1"></i> Avg Calories</span>
                <span class="badge {% if goal_progress.calories.status == 'on_track' %}bg-success{% elif goal_progress.calories.status == 'under' %}bg-info{% else %}bg-warning{% endif %}">
                  {{ goal_progress.calories.current|floatformat:0 }} / {{ goal_progress.calories.target }}
                </span>
              </div>
              <div class="progress" style="height: 12px;">
                <div class="progress-bar {% if goal_progress.calories.status == 'on_track' %}bg-success{% elif goal_progress.calories.status == 'under' %}bg-info{% else %}bg-warning{% endif %}"
                     style="width: {{ goal_progress.calories.progress }}%"></div>
              </div>
              <small class="text-muted">
                {% if goal_progress.calories.status == 'on_track' %}On target
                {% elif goal_progress.calories.status == 'under' %}Under target
                {% else %}Over target{% endif %}
              </small>
            </div>
            {% endif %}

            <!-- Protein Goal -->
            {% if goal_progress.protein %}
            <div class="col-md-6 col-lg-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-drumstick-bite text-success me-1"></i> Avg Protein</span>
                <span class="badge {% if goal_progress.protein.status == 'achieved' %}bg-success{% else %}bg-secondary{% endif %}">
                  {{ goal_progress.protein.current|floatformat:0 }}g / {{ goal_progress.protein.target }}g
                </span>
              </div>
              <div class="progress" style="height: 12px;">
                <div class="progress-bar {% if goal_progress.protein.status == 'achieved' %}bg-success{% else %}bg-secondary{% endif %}"
                     style="width: {{ goal_progress.protein.progress }}%"></div>
              </div>
              <small class="text-muted">
                {% if goal_progress.protein.status == 'achieved' %}Goal achieved!
                {% else %}{{ goal_progress.protein.progress }}% of goal{% endif %}
              </small>
            </div>
            {% endif %}

            <!-- Workouts Goal -->
            {% if goal_progress.workouts %}
            <div class="col-md-6 col-lg-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-dumbbell text-info me-1"></i> Workouts</span>
                <span class="badge {% if goal_progress.workouts.status == 'achieved' %}bg-success{% else %}bg-secondary{% endif %}">
                  {{ goal_progress.workouts.current }} / {{ goal_progress.workouts.target }}
                </span>
              </div>
              <div class="progress" style="height: 12px;">
                <div class="progress-bar {% if goal_progress.workouts.status == 'achieved' %}bg-success{% else %}bg-info{% endif %}"
                     style="width: {{ goal_progress.workouts.progress }}%"></div>
              </div>
              <small class="text-muted">
                {% if goal_progress.workouts.status == 'achieved' %}Goal achieved!
                {% else %}{{ goal_progress.workouts.progress }}% of goal{% endif %}
              </small>
            </div>
            {% endif %}

            <!-- Runs Goal -->
            {% if goal_progress.runs %}
            <div class="col-md-6 col-lg-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-running text-primary me-1"></i> Running Sessions</span>
                <span class="badge {% if goal_progress.runs.status == 'achieved' %}bg-success{% else %}bg-secondary{% endif %}">
                  {{ goal_progress.runs.current }} / {{ goal_progress.runs.target }}
                </span>
              </div>
              <div class="progress" style="height: 12px;">
                <div class="progress-bar {% if goal_progress.runs.status == 'achieved' %}bg-success{% else %}bg-primary{% endif %}"
                     style="width: {{ goal_progress.runs.progress }}%"></div>
              </div>
              <small class="text-muted">
                {% if goal_progress.runs.status == 'achieved' %}Goal achieved!
                {% else %}{{ goal_progress.runs.progress }}% of goal{% endif %}
              </small>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Streaks & Consistency Row -->
  {% if streaks or consistency_score %}
  <div class="row mb-4">
    {% if streaks %}
    <div class="col-12 col-md-6 mb-3 mb-md-0">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-warning text-dark">
          <h2 class="h5 mb-0">Logging Streaks</h2>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <div class="streak-badge">üî•</div>
              <div class="h3 mb-0">{{ streaks.current_streak }}</div>
              <small class="text-muted">Current Streak</small>
            </div>
            <div class="col-4">
              <div class="streak-badge">üèÜ</div>
              <div class="h3 mb-0">{{ streaks.longest_streak }}</div>
              <small class="text-muted">Best Streak</small>
            </div>
            <div class="col-4">
              <div class="streak-badge">üìä</div>
              <div class="h3 mb-0">{{ streaks.consistency_rate }}%</div>
              <small class="text-muted">Consistency</small>
            </div>
          </div>
          <div class="text-center mt-3">
            <small class="text-muted">{{ streaks.total_days }} total days logged</small>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if consistency_score %}
    <div class="col-12 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-info text-white">
          <h2 class="h5 mb-0">Calorie Consistency Score</h2>
        </div>
        <div class="card-body text-center">
          <div class="h1 mb-2">
            {% if consistency_score.score >= 80 %}
              <span class="text-success">{{ consistency_score.score }}</span>
            {% elif consistency_score.score >= 60 %}
              <span class="text-warning">{{ consistency_score.score }}</span>
            {% else %}
              <span class="text-danger">{{ consistency_score.score }}</span>
            {% endif %}
            <small class="text-muted">/100</small>
          </div>
          <h5 class="{% if consistency_score.score >= 80 %}text-success{% elif consistency_score.score >= 60 %}text-warning{% else %}text-danger{% endif %}">
            {{ consistency_score.rating }}
          </h5>
          <p class="text-muted mb-0">{{ consistency_score.description }}</p>
          <small class="text-muted">Coefficient of Variation: {{ consistency_score.cv }}%</small>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Overall Stats -->
  {% if overall_stats %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0">Overall Summary ({{ overall_stats.total_days_logged }} days logged)</h2>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 mb-3">
              <div class="stat-card card bg-light h-100">
                <div class="card-body py-3">
                  <div class="h4 mb-0">{{ overall_stats.avg_daily_calories|floatformat:0 }}</div>
                  <small class="text-muted">Avg Daily Calories</small>
                  {% if overall_stats.calorie_min and overall_stats.calorie_max %}
                  <div class="small text-muted mt-1">
                    Range: {{ overall_stats.calorie_min|floatformat:0 }} - {{ overall_stats.calorie_max|floatformat:0 }}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="stat-card card bg-light h-100">
                <div class="card-body py-3">
                  <div class="h4 mb-0">{{ overall_stats.avg_daily_protein|floatformat:1 }}g</div>
                  <small class="text-muted">Avg Daily Protein</small>
                  <div class="small text-muted mt-1">
                    Total: {{ overall_stats.total_protein|floatformat:0 }}g
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="stat-card card bg-light h-100">
                <div class="card-body py-3">
                  <div class="h4 mb-0">{{ overall_stats.avg_daily_carbs|floatformat:1 }}g</div>
                  <small class="text-muted">Avg Daily Carbs</small>
                  <div class="small text-muted mt-1">
                    Total: {{ overall_stats.total_carbs|floatformat:0 }}g
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="stat-card card bg-light h-100">
                <div class="card-body py-3">
                  <div class="h4 mb-0">{{ overall_stats.avg_daily_fat|floatformat:1 }}g</div>
                  <small class="text-muted">Avg Daily Fat</small>
                  <div class="small text-muted mt-1">
                    Total: {{ overall_stats.total_fat|floatformat:0 }}g
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Macro Analysis -->
  {% if macro_analysis %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h2 class="h5 mb-0">Macronutrient Distribution</h2>
        </div>
        <div class="card-body">
          <!-- Macro Bar -->
          <div class="macro-bar mb-3">
            <div class="macro-segment bg-success" style="width: {{ macro_analysis.protein_percent }}%">
              P: {{ macro_analysis.protein_percent }}%
            </div>
            <div class="macro-segment bg-primary" style="width: {{ macro_analysis.carbs_percent }}%">
              C: {{ macro_analysis.carbs_percent }}%
            </div>
            <div class="macro-segment bg-warning" style="width: {{ macro_analysis.fat_percent }}%">
              F: {{ macro_analysis.fat_percent }}%
            </div>
          </div>

          <div class="row text-center">
            <div class="col-4">
              <span class="badge bg-success">Protein</span>
              <div class="h5 mt-2">{{ macro_analysis.protein_percent }}%</div>
              {% if macro_analysis.protein_per_kg %}
              <small class="text-muted">{{ macro_analysis.protein_per_kg }}g/kg body weight</small>
              {% endif %}
            </div>
            <div class="col-4">
              <span class="badge bg-primary">Carbs</span>
              <div class="h5 mt-2">{{ macro_analysis.carbs_percent }}%</div>
              <small class="text-muted">Recommended: 45-65%</small>
            </div>
            <div class="col-4">
              <span class="badge bg-warning text-dark">Fat</span>
              <div class="h5 mt-2">{{ macro_analysis.fat_percent }}%</div>
              <small class="text-muted">Recommended: 20-35%</small>
            </div>
          </div>

          {% if macro_analysis.balance_notes %}
          <div class="mt-3">
            {% for note in macro_analysis.balance_notes %}
            <div class="alert alert-warning py-2 mb-2">{{ note }}</div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Day of Week Analysis -->
  {% if day_of_week_stats %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <h2 class="h5 mb-0">Day of Week Analysis</h2>
        </div>
        <div class="card-body">
          {% if weekday_insights %}
          <div class="row text-center mb-4">
            <div class="col-6 col-md-3 mb-2">
              <div class="card border-success">
                <div class="card-body py-2">
                  <small class="text-muted">Lowest Day</small>
                  <div class="h6 text-success mb-0">{{ weekday_insights.lowest_day.name }}</div>
                  <small>{{ weekday_insights.lowest_day.calories|floatformat:0 }} kcal</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-2">
              <div class="card border-danger">
                <div class="card-body py-2">
                  <small class="text-muted">Highest Day</small>
                  <div class="h6 text-danger mb-0">{{ weekday_insights.highest_day.name }}</div>
                  <small>{{ weekday_insights.highest_day.calories|floatformat:0 }} kcal</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-2">
              <div class="card border-primary">
                <div class="card-body py-2">
                  <small class="text-muted">Weekday Avg</small>
                  <div class="h6 text-primary mb-0">{{ weekday_insights.weekday_avg|floatformat:0 }}</div>
                  <small>Mon-Fri</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-2">
              <div class="card {% if weekday_insights.weekend_difference > 0 %}border-warning{% else %}border-success{% endif %}">
                <div class="card-body py-2">
                  <small class="text-muted">Weekend Avg</small>
                  <div class="h6 {% if weekday_insights.weekend_difference > 0 %}text-warning{% else %}text-success{% endif %} mb-0">{{ weekday_insights.weekend_avg|floatformat:0 }}</div>
                  <small>{% if weekday_insights.weekend_difference > 0 %}+{% endif %}{{ weekday_insights.weekend_difference|floatformat:0 }} vs weekdays</small>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Daily breakdown bars -->
          <div class="row">
            {% for day, stats in day_of_week_stats.items %}
            <div class="col-12 col-md-6 col-lg-3 mb-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-bold">{{ day }}</span>
                <span>{{ stats.avg_calories|floatformat:0 }} kcal</span>
              </div>
              <div class="day-bar">
                <div class="day-bar-fill {% if stats.avg_calories <= weekday_insights.lowest_day.calories %}bg-success{% elif stats.avg_calories >= weekday_insights.highest_day.calories %}bg-danger{% else %}bg-primary{% endif %}"
                     style="width: {% widthratio stats.avg_calories weekday_insights.highest_day.calories 100 %}%">
                </div>
              </div>
              <small class="text-muted">{{ stats.count }} days logged</small>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Weight Progress & Pace -->
  {% if weight_analysis or weight_pace %}
  <div class="row mb-4">
    {% if weight_analysis %}
    <div class="col-12 col-lg-6 mb-3 mb-lg-0">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h2 class="h5 mb-0">Weight Progress</h2>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4 mb-3">
              <div class="h5 mb-0">{{ weight_analysis.start_weight }} kg</div>
              <small class="text-muted">Start Weight</small>
            </div>
            <div class="col-4 mb-3">
              <div class="h5 mb-0">{{ weight_analysis.end_weight }} kg</div>
              <small class="text-muted">Current Weight</small>
            </div>
            <div class="col-4 mb-3">
              <div class="h5 mb-0 {% if weight_analysis.total_change < 0 %}text-success{% elif weight_analysis.total_change > 0 %}text-danger{% endif %}">
                {% if weight_analysis.total_change > 0 %}+{% endif %}{{ weight_analysis.total_change }} kg
              </div>
              <small class="text-muted">Total Change</small>
            </div>
            <div class="col-4">
              <div class="h6 mb-0">{{ weight_analysis.min_weight }} kg</div>
              <small class="text-muted">Lowest</small>
            </div>
            <div class="col-4">
              <div class="h6 mb-0">{{ weight_analysis.avg_weight }} kg</div>
              <small class="text-muted">Average</small>
            </div>
            <div class="col-4">
              <div class="h6 mb-0">{{ weight_analysis.max_weight }} kg</div>
              <small class="text-muted">Highest</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if weight_pace %}
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-info text-white">
          <h2 class="h5 mb-0">Weight Change Pace</h2>
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-4">
              <div class="h5 mb-0 {% if weight_pace.weekly_rate < 0 %}text-success{% elif weight_pace.weekly_rate > 0 %}text-danger{% endif %}">
                {% if weight_pace.weekly_rate > 0 %}+{% endif %}{{ weight_pace.weekly_rate }} kg
              </div>
              <small class="text-muted">Per Week</small>
            </div>
            <div class="col-4">
              <div class="h5 mb-0 {% if weight_pace.monthly_rate < 0 %}text-success{% elif weight_pace.monthly_rate > 0 %}text-danger{% endif %}">
                {% if weight_pace.monthly_rate > 0 %}+{% endif %}{{ weight_pace.monthly_rate }} kg
              </div>
              <small class="text-muted">Per Month</small>
            </div>
            <div class="col-4">
              <div class="h5 mb-0">{{ weight_pace.days }}</div>
              <small class="text-muted">Days Tracked</small>
            </div>
          </div>

          <div class="alert {% if weight_pace.status == 'losing' %}alert-success{% elif weight_pace.status == 'gaining' %}alert-warning{% else %}alert-info{% endif %} mb-2">
            {{ weight_pace.pace_assessment }}
          </div>

          {% if weight_pace.estimated_daily_deficit %}
          <div class="text-center">
            <small class="text-muted">
              Estimated daily calorie {% if weight_pace.estimated_daily_deficit < 0 %}deficit{% else %}surplus{% endif %}:
              <strong>{{ weight_pace.estimated_daily_deficit|floatformat:0 }} kcal</strong>
            </small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Goal Projections -->
  {% if projections %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-purple text-white" style="background-color: #6f42c1;">
          <h2 class="h5 mb-0">Weight Projections</h2>
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            {% if projections.4_weeks %}
            <div class="col-4">
              <div class="card bg-light">
                <div class="card-body py-3">
                  <small class="text-muted">In 4 Weeks</small>
                  <div class="h4 mb-0">{{ projections.4_weeks }} kg</div>
                </div>
              </div>
            </div>
            {% endif %}
            {% if projections.8_weeks %}
            <div class="col-4">
              <div class="card bg-light">
                <div class="card-body py-3">
                  <small class="text-muted">In 8 Weeks</small>
                  <div class="h4 mb-0">{{ projections.8_weeks }} kg</div>
                </div>
              </div>
            </div>
            {% endif %}
            {% if projections.12_weeks %}
            <div class="col-4">
              <div class="card bg-light">
                <div class="card-body py-3">
                  <small class="text-muted">In 12 Weeks</small>
                  <div class="h4 mb-0">{{ projections.12_weeks }} kg</div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>

          {% if projections.goals %}
          <h6 class="mb-3">Goal Milestones (at current pace)</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Goal Weight</th>
                  <th>Weeks to Reach</th>
                  <th>Estimated Date</th>
                </tr>
              </thead>
              <tbody>
                {% for goal in projections.goals %}
                <tr>
                  <td><strong>{{ goal.weight }} kg</strong></td>
                  <td>{{ goal.weeks|floatformat:0 }} weeks</td>
                  <td>{{ goal.date }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Correlation Insights -->
  {% if insights %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h2 class="h5 mb-0">Personalized Insights ({{ insights|length }})</h2>
        </div>
        <div class="card-body">
          <div class="row">
            {% for insight in insights %}
            <div class="col-12 col-md-6 mb-3">
              <div class="insight-card card h-100 {{ insight.type }}">
                <div class="card-body">
                  <h5 class="card-title">
                    <span class="me-2">{{ insight.icon }}</span>{{ insight.title }}
                  </h5>
                  <p class="card-text">{{ insight.description }}</p>
                  <div class="alert alert-info mb-0 py-2">
                    <strong>Tip:</strong> {{ insight.recommendation }}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h2 class="h5 mb-0">Personalized Insights</h2>
        </div>
        <div class="card-body text-center text-muted">
          <p class="mb-0">Keep logging your food and weight to unlock personalized insights!</p>
          <small>Need at least 3 weight measurements and 7 days of food logs.</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Best/Worst Days -->
  {% if best_worst_days %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
          <h2 class="h5 mb-0">Record Days</h2>
        </div>
        <div class="card-body">
          <div class="row">
            {% if best_worst_days.lowest_calorie_day %}
            <div class="col-6 col-md-3 mb-3">
              <div class="card bg-success text-white h-100">
                <div class="card-body text-center py-3">
                  <h6 class="card-title mb-1">Lowest Calories</h6>
                  <div class="h4 mb-1">{{ best_worst_days.lowest_calorie_day.total_calories|floatformat:0 }}</div>
                  <small>{{ best_worst_days.lowest_calorie_day.day|date:"M d, Y" }}</small>
                </div>
              </div>
            </div>
            {% endif %}
            {% if best_worst_days.highest_calorie_day %}
            <div class="col-6 col-md-3 mb-3">
              <div class="card bg-danger text-white h-100">
                <div class="card-body text-center py-3">
                  <h6 class="card-title mb-1">Highest Calories</h6>
                  <div class="h4 mb-1">{{ best_worst_days.highest_calorie_day.total_calories|floatformat:0 }}</div>
                  <small>{{ best_worst_days.highest_calorie_day.day|date:"M d, Y" }}</small>
                </div>
              </div>
            </div>
            {% endif %}
            {% if best_worst_days.highest_protein_day %}
            <div class="col-6 col-md-3 mb-3">
              <div class="card bg-primary text-white h-100">
                <div class="card-body text-center py-3">
                  <h6 class="card-title mb-1">Most Protein</h6>
                  <div class="h4 mb-1">{{ best_worst_days.highest_protein_day.total_protein|floatformat:0 }}g</div>
                  <small>{{ best_worst_days.highest_protein_day.day|date:"M d, Y" }}</small>
                </div>
              </div>
            </div>
            {% endif %}
            {% if best_worst_days.lowest_protein_day %}
            <div class="col-6 col-md-3 mb-3">
              <div class="card bg-secondary text-white h-100">
                <div class="card-body text-center py-3">
                  <h6 class="card-title mb-1">Least Protein</h6>
                  <div class="h4 mb-1">{{ best_worst_days.lowest_protein_day.total_protein|floatformat:0 }}g</div>
                  <small>{{ best_worst_days.lowest_protein_day.day|date:"M d, Y" }}</small>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Achievements -->
  {% if achievements %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <h2 class="h5 mb-0">Achievements Unlocked ({{ achievements|length }})</h2>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            {% for achievement in achievements %}
            <div class="achievement-badge">
              <div class="achievement-icon">{{ achievement.icon }}</div>
              <div class="fw-bold small">{{ achievement.title }}</div>
              <div class="text-muted" style="font-size: 0.7rem;">{{ achievement.desc }}</div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Nutrition Score & Period Comparison -->
  {% if nutrition_score or period_comparison %}
  <div class="row mb-4">
    {% if nutrition_score %}
    <div class="col-12 col-md-6 mb-3 mb-md-0">
      <div class="card shadow-sm h-100">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #6f42c1, #d63384);">
          <h2 class="h5 mb-0">Nutrition Score</h2>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-4 text-center">
              <div class="grade-circle grade-{{ nutrition_score.grade }} mx-auto">{{ nutrition_score.grade }}</div>
              <div class="h4 mt-2 mb-0">{{ nutrition_score.total }}/100</div>
            </div>
            <div class="col-8">
              {% for item in nutrition_score.breakdown %}
              <div class="mb-2">
                <div class="d-flex justify-content-between small">
                  <span>{{ item.name }}</span>
                  <span class="{% if item.score >= 20 %}text-success{% elif item.score >= 10 %}text-warning{% else %}text-danger{% endif %}">{{ item.score }}/25</span>
                </div>
                <div class="progress" style="height: 6px;">
                  <div class="progress-bar {% if item.score >= 20 %}bg-success{% elif item.score >= 10 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {% widthratio item.score 25 100 %}%"></div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if period_comparison %}
    <div class="col-12 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-info text-white">
          <h2 class="h5 mb-0">vs Previous Period</h2>
        </div>
        <div class="card-body">
          <div class="row text-center">
            {% if period_comparison.calorie_change %}
            <div class="col-4 mb-3">
              <small class="text-muted d-block">Calories</small>
              <div class="h5 mb-0 {% if period_comparison.calorie_change < 0 %}text-success{% elif period_comparison.calorie_change > 0 %}text-danger{% endif %}">
                {% if period_comparison.calorie_change > 0 %}+{% endif %}{{ period_comparison.calorie_change|floatformat:0 }}
              </div>
              <small class="text-muted">({% if period_comparison.calorie_change_percent > 0 %}+{% endif %}{{ period_comparison.calorie_change_percent }}%)</small>
            </div>
            {% endif %}
            {% if period_comparison.protein_change %}
            <div class="col-4 mb-3">
              <small class="text-muted d-block">Protein</small>
              <div class="h5 mb-0 {% if period_comparison.protein_change > 0 %}text-success{% elif period_comparison.protein_change < 0 %}text-danger{% endif %}">
                {% if period_comparison.protein_change > 0 %}+{% endif %}{{ period_comparison.protein_change|floatformat:1 }}g
              </div>
            </div>
            {% endif %}
            {% if period_comparison.weight_change %}
            <div class="col-4 mb-3">
              <small class="text-muted d-block">Avg Weight</small>
              <div class="h5 mb-0 {% if period_comparison.weight_change < 0 %}text-success{% elif period_comparison.weight_change > 0 %}text-danger{% endif %}">
                {% if period_comparison.weight_change > 0 %}+{% endif %}{{ period_comparison.weight_change|floatformat:1 }} kg
              </div>
            </div>
            {% endif %}
          </div>
          <div class="small text-muted text-center">
            Comparing current period to previous {{ period }} days
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Meal Timing & Calorie Distribution -->
  {% if meal_timing or calorie_distribution %}
  <div class="row mb-4">
    {% if meal_timing %}
    <div class="col-12 col-md-6 mb-3 mb-md-0">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-secondary text-white">
          <h2 class="h5 mb-0">Meal Timing</h2>
        </div>
        <div class="card-body">
          <div class="timing-bar mb-3">
            {% if meal_timing.morning.percent > 0 %}
            <div class="timing-segment bg-warning" style="width: {{ meal_timing.morning.percent }}%" title="Morning: {{ meal_timing.morning.calories|floatformat:0 }} kcal">
              {% if meal_timing.morning.percent >= 10 %}{{ meal_timing.morning.percent|floatformat:0 }}%{% endif %}
            </div>
            {% endif %}
            {% if meal_timing.midday.percent > 0 %}
            <div class="timing-segment bg-success" style="width: {{ meal_timing.midday.percent }}%" title="Midday: {{ meal_timing.midday.calories|floatformat:0 }} kcal">
              {% if meal_timing.midday.percent >= 10 %}{{ meal_timing.midday.percent|floatformat:0 }}%{% endif %}
            </div>
            {% endif %}
            {% if meal_timing.afternoon.percent > 0 %}
            <div class="timing-segment bg-info" style="width: {{ meal_timing.afternoon.percent }}%" title="Afternoon: {{ meal_timing.afternoon.calories|floatformat:0 }} kcal">
              {% if meal_timing.afternoon.percent >= 10 %}{{ meal_timing.afternoon.percent|floatformat:0 }}%{% endif %}
            </div>
            {% endif %}
            {% if meal_timing.evening.percent > 0 %}
            <div class="timing-segment bg-primary" style="width: {{ meal_timing.evening.percent }}%" title="Evening: {{ meal_timing.evening.calories|floatformat:0 }} kcal">
              {% if meal_timing.evening.percent >= 10 %}{{ meal_timing.evening.percent|floatformat:0 }}%{% endif %}
            </div>
            {% endif %}
            {% if meal_timing.night.percent > 0 %}
            <div class="timing-segment bg-dark" style="width: {{ meal_timing.night.percent }}%" title="Night: {{ meal_timing.night.calories|floatformat:0 }} kcal">
              {% if meal_timing.night.percent >= 10 %}{{ meal_timing.night.percent|floatformat:0 }}%{% endif %}
            </div>
            {% endif %}
          </div>
          <div class="row small">
            <div class="col text-center"><span class="badge bg-warning text-dark">Morning</span><br>{{ meal_timing.morning.percent|floatformat:0 }}%</div>
            <div class="col text-center"><span class="badge bg-success">Midday</span><br>{{ meal_timing.midday.percent|floatformat:0 }}%</div>
            <div class="col text-center"><span class="badge bg-info">Afternoon</span><br>{{ meal_timing.afternoon.percent|floatformat:0 }}%</div>
            <div class="col text-center"><span class="badge bg-primary">Evening</span><br>{{ meal_timing.evening.percent|floatformat:0 }}%</div>
            <div class="col text-center"><span class="badge bg-dark">Night</span><br>{{ meal_timing.night.percent|floatformat:0 }}%</div>
          </div>
          <div class="text-center mt-3">
            <small class="text-muted">Peak eating time: <strong>{{ meal_timing.peak_period }}</strong></small>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if calorie_distribution %}
    <div class="col-12 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header" style="background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white;">
          <h2 class="h5 mb-0">Calorie Distribution</h2>
        </div>
        <div class="card-body">
          <div class="row small mb-2">
            <div class="col-6">{{ calorie_distribution.very_low.label }} kcal</div>
            <div class="col-6 text-end">{{ calorie_distribution.very_low.count }} days ({{ calorie_distribution.very_low.percent }}%)</div>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar bg-success" style="width: {{ calorie_distribution.very_low.percent }}%">{{ calorie_distribution.very_low.count }}</div>
          </div>

          <div class="row small mb-2">
            <div class="col-6">{{ calorie_distribution.low.label }} kcal</div>
            <div class="col-6 text-end">{{ calorie_distribution.low.count }} days ({{ calorie_distribution.low.percent }}%)</div>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar bg-info" style="width: {{ calorie_distribution.low.percent }}%">{{ calorie_distribution.low.count }}</div>
          </div>

          <div class="row small mb-2">
            <div class="col-6">{{ calorie_distribution.moderate.label }} kcal</div>
            <div class="col-6 text-end">{{ calorie_distribution.moderate.count }} days ({{ calorie_distribution.moderate.percent }}%)</div>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar bg-primary" style="width: {{ calorie_distribution.moderate.percent }}%">{{ calorie_distribution.moderate.count }}</div>
          </div>

          <div class="row small mb-2">
            <div class="col-6">{{ calorie_distribution.high.label }} kcal</div>
            <div class="col-6 text-end">{{ calorie_distribution.high.count }} days ({{ calorie_distribution.high.percent }}%)</div>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar bg-warning" style="width: {{ calorie_distribution.high.percent }}%">{{ calorie_distribution.high.count }}</div>
          </div>

          <div class="row small mb-2">
            <div class="col-6">{{ calorie_distribution.very_high.label }} kcal</div>
            <div class="col-6 text-end">{{ calorie_distribution.very_high.count }} days ({{ calorie_distribution.very_high.percent }}%)</div>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar bg-danger" style="width: {{ calorie_distribution.very_high.percent }}%">{{ calorie_distribution.very_high.count }}</div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Top Foods & Calorie Budget -->
  {% if top_foods or calorie_budget %}
  <div class="row mb-4">
    {% if top_foods.most_frequent %}
    <div class="col-12 col-lg-6 mb-3 mb-lg-0">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h2 class="h5 mb-0">Top 10 Most Eaten Foods</h2>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-striped table-sm mb-0">
              <thead>
                <tr><th>#</th><th>Food</th><th>Times</th><th>Total Cal</th></tr>
              </thead>
              <tbody>
                {% for food in top_foods.most_frequent %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td class="text-truncate" style="max-width: 200px;">{{ food.product_name }}</td>
                  <td>{{ food.count }}x</td>
                  <td>{{ food.total_calories|floatformat:0 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if calorie_budget %}
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header" style="background: linear-gradient(135deg, #198754, #20c997); color: white;">
          <h2 class="h5 mb-0">Calorie Budget ({{ calorie_budget.target }} kcal target)</h2>
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-6">
              <div class="card bg-success text-white">
                <div class="card-body py-3">
                  <div class="h3 mb-0">{{ calorie_budget.days_under }}</div>
                  <small>Days Under Budget</small>
                  <div class="small">({{ calorie_budget.under_percent }}%)</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card bg-danger text-white">
                <div class="card-body py-3">
                  <div class="h3 mb-0">{{ calorie_budget.days_over }}</div>
                  <small>Days Over Budget</small>
                  <div class="small">({{ 100|add:"-"|add:calorie_budget.under_percent|floatformat:1 }}%)</div>
                </div>
              </div>
            </div>
          </div>
          <div class="row text-center small">
            {% if calorie_budget.avg_under_amount %}
            <div class="col-6">
              <span class="text-success">Avg under by {{ calorie_budget.avg_under_amount|floatformat:0 }} kcal</span>
            </div>
            {% endif %}
            {% if calorie_budget.avg_over_amount %}
            <div class="col-6">
              <span class="text-danger">Avg over by {{ calorie_budget.avg_over_amount|floatformat:0 }} kcal</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Weight Volatility -->
  {% if weight_volatility %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header" style="background: linear-gradient(135deg, #6610f2, #e83e8c); color: white;">
          <h2 class="h5 mb-0">Weight Stability Analysis</h2>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 mb-3">
              <div class="h4 mb-0">{{ weight_volatility.avg_fluctuation }} kg</div>
              <small class="text-muted">Avg Daily Fluctuation</small>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="h4 mb-0">{{ weight_volatility.max_fluctuation }} kg</div>
              <small class="text-muted">Max Fluctuation</small>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="h4 mb-0 {% if weight_volatility.stability_score >= 70 %}text-success{% elif weight_volatility.stability_score >= 50 %}text-warning{% else %}text-danger{% endif %}">
                {{ weight_volatility.stability_score }}%
              </div>
              <small class="text-muted">Stability Score</small>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="h4 mb-0 {% if weight_volatility.trend_direction == 'decreasing' %}text-success{% elif weight_volatility.trend_direction == 'increasing' %}text-danger{% else %}text-secondary{% endif %}">
                {% if weight_volatility.trend_change > 0 %}+{% endif %}{{ weight_volatility.trend_change }} kg
              </div>
              <small class="text-muted">Trend ({{ weight_volatility.trend_direction }})</small>
            </div>
          </div>
          <div class="text-center">
            <small class="text-muted">{{ weight_volatility.significant_fluctuations }} significant fluctuations (>0.5 kg) detected</small>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Highest Calorie & Protein Foods -->
  {% if top_foods.highest_calorie or top_foods.highest_protein %}
  <div class="row mb-4">
    {% if top_foods.highest_calorie %}
    <div class="col-12 col-md-6 mb-3 mb-md-0">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white">
          <h2 class="h5 mb-0">Highest Calorie Items</h2>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for food in top_foods.highest_calorie %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="text-truncate" style="max-width: 200px;">{{ food.name }}</div>
              <span class="badge bg-danger">{{ food.calories|floatformat:0 }} kcal</span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}

    {% if top_foods.highest_protein %}
    <div class="col-12 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0">Highest Protein Items</h2>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for food in top_foods.highest_protein %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="text-truncate" style="max-width: 200px;">{{ food.name }}</div>
              <span class="badge bg-primary">{{ food.protein|floatformat:0 }}g protein</span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <div class="row">
    <!-- Weekly Reports -->
    <div class="col-12 col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0">Weekly Reports</h2>
        </div>
        <div class="card-body p-0">
          {% if weekly_reports %}
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped table-hover table-reports mb-0">
              <thead>
                <tr>
                  <th>Week</th>
                  <th>Days</th>
                  <th>Avg Cal</th>
                  <th>Avg P</th>
                  <th>Avg C</th>
                  <th>Avg F</th>
                </tr>
              </thead>
              <tbody>
                {% for week in weekly_reports %}
                <tr>
                  <td>{{ week.week_start|date:"M d" }}</td>
                  <td>{{ week.days_logged }}</td>
                  <td>{{ week.avg_calories|floatformat:0 }}</td>
                  <td>{{ week.avg_protein|floatformat:0 }}g</td>
                  <td>{{ week.avg_carbs|floatformat:0 }}g</td>
                  <td>{{ week.avg_fat|floatformat:0 }}g</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center text-muted p-4">
            No weekly data available yet.
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Monthly Reports -->
    <div class="col-12 col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h2 class="h5 mb-0">Monthly Reports</h2>
        </div>
        <div class="card-body p-0">
          {% if monthly_reports %}
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped table-hover table-reports mb-0">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Days</th>
                  <th>Avg Cal</th>
                  <th>Avg P</th>
                  <th>Avg C</th>
                  <th>Avg F</th>
                </tr>
              </thead>
              <tbody>
                {% for month in monthly_reports %}
                <tr>
                  <td>{{ month.month|date:"M Y" }}</td>
                  <td>{{ month.days_logged }}</td>
                  <td>{{ month.avg_calories|floatformat:0 }}</td>
                  <td>{{ month.avg_protein|floatformat:0 }}g</td>
                  <td>{{ month.avg_carbs|floatformat:0 }}g</td>
                  <td>{{ month.avg_fat|floatformat:0 }}g</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center text-muted p-4">
            No monthly data available yet.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
