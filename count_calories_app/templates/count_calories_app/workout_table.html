{% extends "base.html" %}
{% load static %}

{% block title %}Workout Table{% endblock %}

{% block css_files %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'count_calories_app/count_calories_app.css' %}">
  <style>
    .workout-table {
      width: 100%;
      overflow-x: auto;
    }
    .workout-table table {
      min-width: 100%;
      border-collapse: collapse;
    }
    .workout-table th, .workout-table td {
      border: 1px solid var(--border-color, #dee2e6);
      padding: 8px;
      position: relative;
    }
    .workout-table th {
      background-color: var(--bg-tertiary, #f8f9fa);
      font-weight: bold;
      text-align: center;
    }
    .workout-table .exercise-name {
      min-width: 200px;
      background-color: var(--bg-tertiary, #f8f9fa);
      font-weight: bold;
    }
    .workout-table .editable {
      min-width: 100px;
      cursor: pointer;
      background-color: var(--bg-card, #fff);
      color: var(--text-primary, #212529);
    }
    .workout-table .editable:hover {
      background-color: var(--bg-hover, #f0f0f0);
    }
    .workout-table .editable:focus {
      outline: 2px solid var(--accent-primary, #007bff);
      background-color: var(--bg-card, #fff);
    }
    .workout-table .add-row, .workout-table .add-column {
      cursor: pointer;
      background-color: rgba(34, 197, 94, 0.2);
      text-align: center;
      font-weight: bold;
      color: var(--accent-success, #0f5132);
      transition: all 0.2s;
    }
    .workout-table .add-row:hover, .workout-table .add-column:hover {
      background-color: rgba(34, 197, 94, 0.3);
      transform: scale(1.02);
    }
    .workout-table .delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      cursor: pointer;
      color: var(--accent-danger, #dc3545);
      font-size: 14px;
      opacity: 0.3;
      transition: all 0.2s;
      background-color: var(--bg-card, rgba(255, 255, 255, 0.7));
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .workout-table th:hover .delete-btn, .workout-table .exercise-name:hover .delete-btn {
      opacity: 1;
    }
    .workout-table .delete-btn:hover {
      background-color: var(--accent-danger, #dc3545);
      color: white;
      transform: scale(1.1);
    }
    .save-table-btn {
      margin-top: 20px;
    }
    /* PR (personal record) cell */
    .workout-table .pr-cell {
      background-color: rgba(255, 193, 7, 0.18) !important;
      box-shadow: inset 0 0 0 2px rgba(255, 193, 7, 0.6);
    }
    /* Progress button inside exercise-name cell */
    .workout-table .progress-btn {
      position: absolute;
      bottom: 2px;
      right: 2px;
      cursor: pointer;
      color: #0d6efd;
      font-size: 13px;
      opacity: 0.3;
      transition: all 0.2s;
      background-color: var(--bg-card, rgba(255,255,255,0.7));
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .workout-table .exercise-name:hover .progress-btn {
      opacity: 1;
    }
    .workout-table .progress-btn:hover {
      background-color: #0d6efd;
      color: white;
      transform: scale(1.1);
    }
    /* Responsive table styles */
    @media (max-width: 768px) {
      .workout-table {
        overflow-x: scroll;
      }
      .workout-table .exercise-name {
        min-width: 150px;
      }
      .workout-table .editable {
        min-width: 80px;
      }
    }
  </style>
{% endblock %}

{% block content %}
  {% csrf_token %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3">Workout Table</h1>
        <div>
          <button id="save-table" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Save Workout Table
          </button>
          <button id="new-table" class="btn btn-outline-secondary ms-2">
            <i class="fas fa-plus me-1"></i>New Table
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Table Controls -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h3 class="h5 mb-0">Table Controls</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label for="columns-input" class="form-label">Number of Columns:</label>
              <div class="input-group">
                <input type="number" id="columns-input" class="form-control" min="1" max="50" value="1">
                <button id="set-columns" class="btn btn-outline-primary">Set</button>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <label for="rows-input" class="form-label">Number of Rows:</label>
              <div class="input-group">
                <input type="number" id="rows-input" class="form-control" min="1" max="50" value="1">
                <button id="set-rows" class="btn btn-outline-primary">Set</button>
              </div>
            </div>
          </div>
          <div class="alert alert-info mt-2 mb-0">
            <i class="fas fa-info-circle me-2"></i>You can add or remove columns and rows at any time using the buttons in the table.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm rounded">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Workout Progress Table</h2>
            <div class="input-group input-group-sm" style="max-width: 300px;">
              <input type="text" id="table-name" class="form-control" placeholder="Table Name (e.g., Upper Body Workout)">
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="workout-table">
            <table id="workout-table" class="table table-bordered mb-0">
              <thead>
                <tr id="header-row">
                  <th class="exercise-name">Exercise</th>
                  <th class="editable" contenteditable="true">Workout 1
                    <span class="delete-btn"><i class="fas fa-times"></i></span>
                  </th>
                  <th class="add-column" id="add-column">
                    <i class="fas fa-plus-circle me-1"></i> Add Workout
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="exercise-name" contenteditable="true">
                    Exercise 1
                    <span class="delete-btn"><i class="fas fa-times"></i></span>
                  </td>
                  <td class="editable" contenteditable="true"></td>
                  <td class="add-column"></td>
                </tr>
                <tr id="add-row-row">
                  <td class="add-row" id="add-row" colspan="3">
                    <i class="fas fa-plus-circle me-1"></i> Add Exercise
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Saved Tables Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm rounded">
        <div class="card-header bg-success text-white">
          <h2 class="h5 mb-0">Saved Workout Tables</h2>
        </div>
        <div class="card-body p-0">
          <div id="saved-tables-container">
            <!-- Saved tables will be loaded here -->
            <div class="text-center py-4 text-muted">
              No saved workout tables yet. Create and save your first table above.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_body %}
<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="progressModalLabel">
          <i class="fas fa-chart-line me-2"></i>Progress: <span id="progress-exercise-name"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Stats summary cards -->
        <div class="row mb-4" id="progress-stats"></div>
        <!-- Charts -->
        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <canvas id="weightChart"></canvas>
          </div>
          <div class="col-md-6 mb-3">
            <canvas id="volumeChart"></canvas>
          </div>
        </div>
        <!-- Session breakdown table -->
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover" id="sessions-breakdown-table"></table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js_files %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const workoutTable = document.getElementById('workout-table');
      const addRowBtn = document.getElementById('add-row');
      const addColumnBtn = document.getElementById('add-column');
      const saveTableBtn = document.getElementById('save-table');
      const newTableBtn = document.getElementById('new-table');
      const tableNameInput = document.getElementById('table-name');
      const savedTablesContainer = document.getElementById('saved-tables-container');

      // Track the currently loaded table index (-1 means creating a new table)
      let currentTableIndex = -1;

      // Strip HTML on paste ‚Äî only insert plain text into contenteditable cells
      function handlePaste(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        const sel = window.getSelection();
        if (!sel || !sel.rangeCount) return;
        sel.deleteFromDocument();
        sel.getRangeAt(0).insertNode(document.createTextNode(text));
        sel.collapseToEnd();
      }

      // Apply paste handler to all contenteditable cells in the table
      // Also re-highlight PRs when a data cell loses focus (user finished editing)
      function applyPasteHandlers() {
        workoutTable.querySelectorAll('[contenteditable="true"]').forEach(el => {
          el.removeEventListener('paste', handlePaste);
          el.addEventListener('paste', handlePaste);
        });
        workoutTable.querySelectorAll('.editable[contenteditable="true"]').forEach(el => {
          el.removeEventListener('blur', highlightPRs);
          el.addEventListener('blur', highlightPRs);
        });
      }

      // ‚îÄ‚îÄ Progress tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      // Parse "60x8, 65x8, 70x6" ‚Üí [{weight, reps}, ...]
      // Also accepts "60X8" or "60√ó8"
      function parseCell(text) {
        const sets = [];
        text.split(',').map(s => s.trim()).filter(Boolean).forEach(part => {
          const m = part.match(/^([\d.]+)\s*[xX√ó]\s*(\d+)$/);
          if (m) sets.push({ weight: parseFloat(m[1]), reps: parseInt(m[2]) });
        });
        return sets;
      }

      // Calculate key stats from a set array
      function calcStats(sets) {
        if (!sets.length) return null;
        const maxWeight   = Math.max(...sets.map(s => s.weight));
        const totalVolume = Math.round(sets.reduce((sum, s) => sum + s.weight * s.reps, 0));
        const totalReps   = sets.reduce((sum, s) => sum + s.reps, 0);
        return { maxWeight, totalVolume, totalReps, sets: sets.length };
      }

      // Clean text from a cell (strips delete-btn / progress-btn text)
      function cleanCellText(cell) {
        const clone = cell.cloneNode(true);
        clone.querySelectorAll('.delete-btn, .progress-btn').forEach(el => el.remove());
        return clone.textContent.trim();
      }

      // Highlight the session with the heaviest max weight per exercise row
      function highlightPRs() {
        workoutTable.querySelectorAll('.pr-cell').forEach(el => el.classList.remove('pr-cell'));
        Array.from(workoutTable.tBodies[0].rows).forEach(row => {
          if (row.id === 'add-row-row') return;
          let best = -Infinity, bestIdx = -1;
          for (let j = 1; j < row.cells.length - 1; j++) {
            const stats = calcStats(parseCell(row.cells[j].textContent.trim()));
            if (stats && stats.maxWeight > best) { best = stats.maxWeight; bestIdx = j; }
          }
          if (bestIdx > 0) row.cells[bestIdx].classList.add('pr-cell');
        });
      }

      // Add a small chart-line button to every exercise-name cell
      function applyProgressButtons() {
        workoutTable.querySelectorAll('tbody .exercise-name').forEach(cell => {
          cell.querySelectorAll('.progress-btn').forEach(el => el.remove());
          const btn = document.createElement('span');
          btn.className = 'progress-btn';
          btn.title = 'View Progress';
          btn.innerHTML = '<i class="fas fa-chart-line"></i>';
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            showProgressModal(cleanCellText(cell), cell.closest('tr'));
          });
          cell.appendChild(btn);
        });
      }

      // Open the progress modal for one exercise row
      function showProgressModal(exerciseName, row) {
        // Collect session labels from header
        const headerRow = document.getElementById('header-row');
        const sessions = [];
        for (let i = 1; i < headerRow.cells.length - 1; i++) {
          sessions.push(cleanCellText(headerRow.cells[i]));
        }

        // Collect per-session stats for this exercise
        const sessionData = [];
        for (let j = 1; j < row.cells.length - 1; j++) {
          const raw  = row.cells[j].textContent.trim();
          const sets = parseCell(raw);
          sessionData.push({ session: sessions[j - 1] || `Session ${j}`, stats: calcStats(sets), raw });
        }

        const withData = sessionData.filter(d => d.stats);
        if (!withData.length) {
          alert('No valid data found.\nEnter sets like: 60x8, 65x8, 70x6');
          return;
        }

        // Summary numbers
        const first  = withData[0].stats;
        const latest = withData[withData.length - 1].stats;
        const prVal  = Math.max(...withData.map(d => d.stats.maxWeight));
        const prSess = withData.find(d => d.stats.maxWeight === prVal);
        const pctWeight = ((latest.maxWeight - first.maxWeight) / first.maxWeight * 100).toFixed(1);
        const pctVol    = ((latest.totalVolume - first.totalVolume) / first.totalVolume * 100).toFixed(1);
        const pos = v => parseFloat(v) >= 0;

        // ‚îÄ‚îÄ Modal title
        document.getElementById('progress-exercise-name').textContent = exerciseName;

        // ‚îÄ‚îÄ Stats cards
        document.getElementById('progress-stats').innerHTML = `
          <div class="col-6 col-md-3 mb-2">
            <div class="card text-center h-100">
              <div class="card-body py-2">
                <div class="text-muted small">First Session</div>
                <div class="fw-bold fs-5">${first.maxWeight} kg</div>
                <div class="text-muted small">${first.sets} sets ¬∑ ${first.totalReps} reps</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3 mb-2">
            <div class="card text-center h-100">
              <div class="card-body py-2">
                <div class="text-muted small">Latest Session</div>
                <div class="fw-bold fs-5">${latest.maxWeight} kg</div>
                <div class="text-muted small">${latest.sets} sets ¬∑ ${latest.totalReps} reps</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3 mb-2">
            <div class="card text-center border-warning h-100">
              <div class="card-body py-2">
                <div class="text-muted small">üèÜ Personal Record</div>
                <div class="fw-bold fs-5 text-warning">${prVal} kg</div>
                <div class="text-muted small">${prSess ? prSess.session : ''}</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3 mb-2">
            <div class="card text-center h-100">
              <div class="card-body py-2">
                <div class="text-muted small">Progress</div>
                <div class="fw-bold fs-5 ${pos(pctWeight) ? 'text-success' : 'text-danger'}">
                  ${pos(pctWeight) ? '‚Üë' : '‚Üì'} ${Math.abs(pctWeight)}% weight
                </div>
                <div class="small ${pos(pctVol) ? 'text-success' : 'text-danger'}">
                  ${pos(pctVol) ? '‚Üë' : '‚Üì'} ${Math.abs(pctVol)}% volume
                </div>
              </div>
            </div>
          </div>`;

        // ‚îÄ‚îÄ Destroy old charts
        ['weightChart', 'volumeChart'].forEach(id => {
          const c = Chart.getChart(id);
          if (c) c.destroy();
        });

        const labels     = withData.map(d => d.session);
        const maxWeights = withData.map(d => d.stats.maxWeight);
        const volumes    = withData.map(d => d.stats.totalVolume);
        const baseOpts   = {
          responsive: true,
          tension: 0.35,
          plugins: { legend: { display: false } },
          scales: { x: { ticks: { maxRotation: 45, font: { size: 11 } } } }
        };

        new Chart(document.getElementById('weightChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              data: maxWeights,
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13,110,253,0.1)',
              fill: true, pointRadius: 5, pointHoverRadius: 8
            }]
          },
          options: { ...baseOpts, plugins: { ...baseOpts.plugins,
            title: { display: true, text: 'Max Weight per Session (kg)' } } }
        });

        new Chart(document.getElementById('volumeChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              data: volumes,
              borderColor: '#198754',
              backgroundColor: 'rgba(25,135,84,0.1)',
              fill: true, pointRadius: 5, pointHoverRadius: 8
            }]
          },
          options: { ...baseOpts, plugins: { ...baseOpts.plugins,
            title: { display: true, text: 'Total Volume per Session (kg¬∑reps)' } } }
        });

        // ‚îÄ‚îÄ Session breakdown table
        let html = `<thead class="table-light"><tr>
          <th>Session</th><th>Max Weight</th><th>Total Volume</th>
          <th>Total Reps</th><th>Sets</th><th>Entry</th>
        </tr></thead><tbody>`;
        sessionData.forEach(d => {
          if (!d.stats) return;
          const isPR = d.stats.maxWeight === prVal;
          html += `<tr ${isPR ? 'class="table-warning"' : ''}>
            <td>${d.session}</td>
            <td>${d.stats.maxWeight} kg${isPR ? ' üèÜ' : ''}</td>
            <td>${d.stats.totalVolume}</td>
            <td>${d.stats.totalReps}</td>
            <td>${d.stats.sets}</td>
            <td><code>${d.raw}</code></td>
          </tr>`;
        });
        html += '</tbody>';
        document.getElementById('sessions-breakdown-table').innerHTML = html;

        new bootstrap.Modal(document.getElementById('progressModal')).show();
      }

      // ‚îÄ‚îÄ End progress tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      // Add a new row (exercise)
      addRowBtn.addEventListener('click', function() {
        const newRow = document.createElement('tr');
        const exerciseCell = document.createElement('td');
        exerciseCell.className = 'exercise-name';
        exerciseCell.contentEditable = true;
        exerciseCell.innerHTML = 'New Exercise <span class="delete-btn"><i class="fas fa-times"></i></span>';

        newRow.appendChild(exerciseCell);

        // Add cells for each workout column
        const headerRow = document.getElementById('header-row');
        const workoutCount = headerRow.cells.length - 2; // Subtract Exercise and Add Column cells

        for (let i = 0; i < workoutCount; i++) {
          const workoutCell = document.createElement('td');
          workoutCell.className = 'editable';
          workoutCell.contentEditable = true;
          newRow.appendChild(workoutCell);
        }

        // Add empty cell for the add column button
        const emptyCell = document.createElement('td');
        emptyCell.className = 'add-column';
        newRow.appendChild(emptyCell);

        // Insert the new row before the add row button
        const addRowRow = document.getElementById('add-row-row');
        workoutTable.tBodies[0].insertBefore(newRow, addRowRow);

        setupDeleteButtons();
        applyPasteHandlers();
        applyProgressButtons();
        highlightPRs();
      });

      // Add a new column (workout)
      addColumnBtn.addEventListener('click', function() {
        // Add header cell
        const headerRow = document.getElementById('header-row');
        const newHeaderCell = document.createElement('th');
        newHeaderCell.className = 'editable';
        newHeaderCell.contentEditable = true;
        newHeaderCell.innerHTML = 'New Workout <span class="delete-btn"><i class="fas fa-times"></i></span>';

        // Insert before the add column button
        headerRow.insertBefore(newHeaderCell, headerRow.lastElementChild);

        // Add cells to each row
        const rows = workoutTable.tBodies[0].rows;
        for (let i = 0; i < rows.length - 1; i++) { // Skip the add row button
          if (rows[i].id !== 'add-row-row') {
            const newCell = document.createElement('td');
            newCell.className = 'editable';
            newCell.contentEditable = true;
            rows[i].insertBefore(newCell, rows[i].lastElementChild);
          }
        }

        // Update the colspan of the add row button
        const addRowCell = document.getElementById('add-row');
        addRowCell.colSpan = headerRow.cells.length;

        setupDeleteButtons();
        applyPasteHandlers();
        applyProgressButtons();
        highlightPRs();
      });

      // Setup delete buttons for rows and columns
      function setupDeleteButtons() {
        // Delete row buttons
        const deleteRowBtns = document.querySelectorAll('.exercise-name .delete-btn');
        deleteRowBtns.forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const row = this.closest('tr');
            row.remove();
          });
        });

        // Delete column buttons
        const deleteColumnBtns = document.querySelectorAll('#header-row th:not(:first-child):not(:last-child) .delete-btn');
        deleteColumnBtns.forEach((btn, index) => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const columnIndex = this.closest('th').cellIndex;

            // Remove the header cell
            const headerRow = document.getElementById('header-row');
            headerRow.deleteCell(columnIndex);

            // Remove the corresponding cell in each row
            const rows = workoutTable.tBodies[0].rows;
            for (let i = 0; i < rows.length - 1; i++) { // Skip the add row button
              if (rows[i].id !== 'add-row-row') {
                rows[i].deleteCell(columnIndex);
              }
            }

            // Update the colspan of the add row button
            const addRowCell = document.getElementById('add-row');
            addRowCell.colSpan = headerRow.cells.length;
          });
        });
      }

      // Initialize delete buttons, paste handlers, and progress buttons
      setupDeleteButtons();
      applyPasteHandlers();
      applyProgressButtons();
      highlightPRs();

      // Set columns button
      document.getElementById('set-columns').addEventListener('click', function() {
        const columnsInput = document.getElementById('columns-input');
        const columnCount = parseInt(columnsInput.value);

        if (isNaN(columnCount) || columnCount < 1 || columnCount > 50) {
          alert('Please enter a valid number of columns between 1 and 50.');
          return;
        }

        // Get current column count (excluding Exercise column and Add Column button)
        const headerRow = document.getElementById('header-row');
        const currentColumnCount = headerRow.cells.length - 2;

        if (columnCount === currentColumnCount) {
          return; // No change needed
        }

        if (columnCount > currentColumnCount) {
          // Add columns
          for (let i = 0; i < columnCount - currentColumnCount; i++) {
            // Simulate clicking the add column button
            addColumnBtn.click();
          }
        } else {
          // Remove columns from the end
          for (let i = 0; i < currentColumnCount - columnCount; i++) {
            // Get the last workout column (before the add column button)
            const lastColumnIndex = headerRow.cells.length - 2;
            const lastColumn = headerRow.cells[lastColumnIndex];

            // Simulate clicking its delete button
            const deleteBtn = lastColumn.querySelector('.delete-btn');
            if (deleteBtn) {
              deleteBtn.click();
            }
          }
        }
      });

      // Set rows button
      document.getElementById('set-rows').addEventListener('click', function() {
        const rowsInput = document.getElementById('rows-input');
        const rowCount = parseInt(rowsInput.value);

        if (isNaN(rowCount) || rowCount < 1 || rowCount > 50) {
          alert('Please enter a valid number of rows between 1 and 50.');
          return;
        }

        // Get current row count (excluding the add row button)
        const tbody = workoutTable.tBodies[0];
        const currentRowCount = tbody.rows.length - 1;

        if (rowCount === currentRowCount) {
          return; // No change needed
        }

        if (rowCount > currentRowCount) {
          // Add rows
          for (let i = 0; i < rowCount - currentRowCount; i++) {
            // Simulate clicking the add row button
            addRowBtn.click();
          }
        } else {
          // Remove rows from the end
          for (let i = 0; i < currentRowCount - rowCount; i++) {
            // Get the last exercise row (before the add row button)
            const lastRowIndex = tbody.rows.length - 2;
            const lastRow = tbody.rows[lastRowIndex];

            // Simulate clicking its delete button
            const deleteBtn = lastRow.cells[0].querySelector('.delete-btn');
            if (deleteBtn) {
              deleteBtn.click();
            }
          }
        }
      });

      // Save the table
      saveTableBtn.addEventListener('click', function() {
        try {
          console.log('Save button clicked. Current table index:', currentTableIndex);

          const tableName = tableNameInput.value.trim() || 'Workout Table';
          console.log('Table name:', tableName);

          // Get table data
          const tableData = {
            workouts: [],
            exercises: []
          };

          // Get workout names (column headers)
          const headerRow = document.getElementById('header-row');
          for (let i = 1; i < headerRow.cells.length - 1; i++) {
            // Clone the cell to manipulate it safely
            const cellClone = headerRow.cells[i].cloneNode(true);

            // Remove the delete button from the clone
            const deleteBtnInClone = cellClone.querySelector('.delete-btn');
            if (deleteBtnInClone) {
              deleteBtnInClone.remove();
            }

            // Now get the clean text content
            const workoutName = cellClone.textContent.trim();
            tableData.workouts.push(workoutName);
          }
          console.log('Workouts collected:', tableData.workouts);

          // Get exercise data
          const rows = workoutTable.tBodies[0].rows;
          const workoutCount = tableData.workouts.length; // Get the number of workout columns

          for (let i = 0; i < rows.length - 1; i++) { // Skip the add row button
            if (rows[i].id !== 'add-row-row') {
              // Clone the cell to manipulate it safely
              const cellClone = rows[i].cells[0].cloneNode(true);

              // Remove the delete button from the clone
              const deleteBtnInClone = cellClone.querySelector('.delete-btn');
              if (deleteBtnInClone) {
                deleteBtnInClone.remove();
              }

              // Now get the clean text content
              const exerciseName = cellClone.textContent.trim();

              const exerciseData = {
                name: exerciseName,
                workouts: []
              };

              // Get workout data for this exercise
              for (let j = 0; j < workoutCount; j++) {
                // Check if the cell exists and get its content, otherwise use empty string
                const cellContent = (j + 1 < rows[i].cells.length - 1) ? 
                  rows[i].cells[j + 1].textContent.trim() : '';
                exerciseData.workouts.push(cellContent);
              }

              // Ensure the workouts array has exactly the same length as the number of workout columns
              while (exerciseData.workouts.length < workoutCount) {
                exerciseData.workouts.push('');
              }

              tableData.exercises.push(exerciseData);
            }
          }
          console.log('Exercises collected:', tableData.exercises);

          // Prepare data for API request
          const requestData = {
            name: tableName,
            data: tableData
          };

          // If we're editing an existing table, include the ID
          if (currentTableIndex > 0) {
            requestData.id = currentTableIndex;
          }

          // Send data to server
          fetch('{% url "save_workout_table" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(requestData)
          })
          .then(response => response.json())
          .then(data => {
            console.log('Server response:', data);

            if (data.success) {
              // Update current table index if this was a new table
              if (currentTableIndex <= 0) {
                currentTableIndex = data.id;
                saveTableBtn.innerHTML = `<i class="fas fa-save me-1"></i>Update Table`;
              }
              localStorage.setItem('lastWorkoutTableId', currentTableIndex);

              alert(data.message);

              // Update the saved tables display
              loadSavedTables();
            } else {
              alert('Error: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error saving workout table:', error);
            alert('Error saving workout table: ' + error.message);
          });

          console.log('Save request sent');
        } catch (error) {
          console.error('Error preparing workout table data:', error);
          alert('Error preparing workout table data: ' + error.message);
        }
      });

      // Load saved tables
      // autoLoad: if true, restore the last-used table from localStorage on initial page load
      function loadSavedTables(autoLoad = false) {
        try {
          fetch('{% url "get_workout_tables" %}')
            .then(response => response.json())
            .then(data => {
              if (!data.success) {
                console.error('Error from server:', data.message);
                return;
              }

              const savedTables = data.tables;

              if (savedTables.length === 0) {
                savedTablesContainer.innerHTML = `
                  <div class="text-center py-4 text-muted">
                    No saved workout tables yet. Create and save your first table above.
                  </div>
                `;
                return;
              }

              let html = '<div class="list-group list-group-flush">';
              savedTables.forEach((table) => {
                html += `
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="mb-1">${table.name}</h5>
                        <small class="text-muted">Created: ${table.date}</small>
                      </div>
                      <div>
                        <button class="btn btn-sm btn-outline-primary load-table-btn" data-id="${table.id}">
                          <i class="fas fa-edit me-1"></i>Load
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-table-btn ms-2" data-id="${table.id}">
                          <i class="fas fa-trash me-1"></i>Delete
                        </button>
                      </div>
                    </div>
                  </div>
                `;
              });
              html += '</div>';
              savedTablesContainer.innerHTML = html;

              document.querySelectorAll('.load-table-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                  loadTable(this.getAttribute('data-id'), savedTables);
                });
              });

              document.querySelectorAll('.delete-table-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                  deleteTable(this.getAttribute('data-id'));
                });
              });

              // On initial page load, auto-restore the last used table
              if (autoLoad) {
                const lastId = localStorage.getItem('lastWorkoutTableId');
                if (lastId) {
                  const match = savedTables.find(t => String(t.id) === lastId);
                  if (match) {
                    loadTable(lastId, savedTables);
                  }
                }
              }
            })
            .catch(error => {
              console.error('Error fetching saved tables:', error);
            });
        } catch (error) {
          console.error('Error in loadSavedTables function:', error);
        }
      }

      // Load a saved table.
      // tablesList is optional ‚Äî pass the already-fetched array to avoid a second request.
      function loadTable(tableId, tablesList) {
        function populateTable(tableData) {
          currentTableIndex = parseInt(tableId);
          localStorage.setItem('lastWorkoutTableId', tableId);

          saveTableBtn.innerHTML = `<i class="fas fa-save me-1"></i>Update Table`;
          tableNameInput.value = tableData.name;

          clearTable(true);

          const workouts = tableData.data.workouts || [];
          const exercises = tableData.data.exercises || [];

          // Add workout columns
          workouts.forEach(workout => {
            const headerRow = document.getElementById('header-row');
            const newHeaderCell = document.createElement('th');
            newHeaderCell.className = 'editable';
            newHeaderCell.contentEditable = true;
            newHeaderCell.textContent = workout;
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            newHeaderCell.appendChild(deleteBtn);
            headerRow.insertBefore(newHeaderCell, headerRow.lastElementChild);
          });

          // Add exercise rows
          exercises.forEach(exercise => {
            const newRow = document.createElement('tr');
            const exerciseCell = document.createElement('td');
            exerciseCell.className = 'exercise-name';
            exerciseCell.contentEditable = true;
            exerciseCell.textContent = exercise.name;
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            exerciseCell.appendChild(deleteBtn);
            newRow.appendChild(exerciseCell);

            for (let wIdx = 0; wIdx < workouts.length; wIdx++) {
              const workoutCell = document.createElement('td');
              workoutCell.className = 'editable';
              workoutCell.contentEditable = true;
              workoutCell.textContent = wIdx < exercise.workouts.length ? exercise.workouts[wIdx] : '';
              newRow.appendChild(workoutCell);
            }

            const emptyCell = document.createElement('td');
            emptyCell.className = 'add-column';
            newRow.appendChild(emptyCell);

            workoutTable.tBodies[0].insertBefore(newRow, document.getElementById('add-row-row'));
          });

          const headerRow = document.getElementById('header-row');
          document.getElementById('add-row').colSpan = headerRow.cells.length;
          document.getElementById('columns-input').value = workouts.length;
          document.getElementById('rows-input').value = exercises.length;

          setupDeleteButtons();
          applyPasteHandlers();
          applyProgressButtons();
          highlightPRs();
        }

        // If the caller already has the list, use it directly
        if (tablesList) {
          const tableData = tablesList.find(t => String(t.id) === String(tableId));
          if (tableData) {
            populateTable(tableData);
          }
          return;
        }

        // Otherwise fetch from server
        fetch('{% url "get_workout_tables" %}')
          .then(response => response.json())
          .then(data => {
            if (!data.success) { return; }
            const tableData = data.tables.find(t => String(t.id) === String(tableId));
            if (tableData) { populateTable(tableData); }
          })
          .catch(error => console.error('Error fetching table data:', error));
      }

      // Delete a saved table
      function deleteTable(tableId) {
        try {
          console.log('Delete table function called with ID:', tableId);

          if (confirm('Are you sure you want to delete this workout table?')) {
            console.log('User confirmed deletion');

            // Send delete request to server
            fetch(`{% url "delete_workout_table" table_id=0 %}`.replace('0', tableId), {
              method: 'DELETE',
              headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
            })
            .then(response => response.json())
            .then(data => {
              console.log('Server response:', data);

              if (data.success) {
                console.log('Table deleted successfully, updating display');
                // Update the saved tables display
                loadSavedTables();

                // If we deleted the currently loaded table, reset to new table mode
                if (currentTableIndex === parseInt(tableId)) {
                  currentTableIndex = -1;
                  localStorage.removeItem('lastWorkoutTableId');
                  saveTableBtn.innerHTML = `<i class="fas fa-save me-1"></i>Save Workout Table`;
                  clearTable();
                }

                alert('Workout table deleted successfully!');
              } else {
                console.error('Error from server:', data.message);
                alert('Error: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error sending delete request:', error);
              alert('Error deleting workout table: ' + error.message);
            });

            console.log('Delete request sent');
          } else {
            console.log('User cancelled deletion');
          }
        } catch (error) {
          console.error('Error in deleteTable function:', error);
          alert('Error deleting workout table: ' + error.message);
        }
      }

      // Clear the current table
      // If forLoading is true, don't add default rows/columns (used when loading a saved table)
      function clearTable(forLoading = false) {
        // Reset current table index if not called from loadTable
        if (!forLoading) {
          currentTableIndex = -1;
          saveTableBtn.innerHTML = `<i class="fas fa-save me-1"></i>Save Workout Table`;
        }

        // Clear all rows except the header and add row button
        const rows = workoutTable.tBodies[0].rows;
        while (rows.length > 1) {
          if (rows[0].id !== 'add-row-row') {
            rows[0].remove();
          } else {
            break;
          }
        }

        // Clear all columns except the first (Exercise) and last (Add Column)
        const headerRow = document.getElementById('header-row');
        while (headerRow.cells.length > 2) {
          headerRow.deleteCell(1);
        }

        // Only add default content if not loading a table
        if (!forLoading) {
          // Add a default workout column
          const newHeaderCell = document.createElement('th');
          newHeaderCell.className = 'editable';
          newHeaderCell.contentEditable = true;
          newHeaderCell.innerHTML = 'Workout 1 <span class="delete-btn"><i class="fas fa-times"></i></span>';

          // Insert before the add column button
          headerRow.insertBefore(newHeaderCell, headerRow.lastElementChild);

          // Add a default exercise row
          const newRow = document.createElement('tr');
          const exerciseCell = document.createElement('td');
          exerciseCell.className = 'exercise-name';
          exerciseCell.contentEditable = true;
          exerciseCell.innerHTML = 'Exercise 1 <span class="delete-btn"><i class="fas fa-times"></i></span>';

          newRow.appendChild(exerciseCell);

          // Add workout data cell
          const workoutCell = document.createElement('td');
          workoutCell.className = 'editable';
          workoutCell.contentEditable = true;
          newRow.appendChild(workoutCell);

          // Add empty cell for the add column button
          const emptyCell = document.createElement('td');
          emptyCell.className = 'add-column';
          newRow.appendChild(emptyCell);

          // Insert the new row before the add row button
          const addRowRow = document.getElementById('add-row-row');
          workoutTable.tBodies[0].insertBefore(newRow, addRowRow);

          // Reset the column and row input values to match the default table
          document.getElementById('columns-input').value = '1';
          document.getElementById('rows-input').value = '1';
        }

        // Update the colspan of the add row button
        const addRowCell = document.getElementById('add-row');
        if (addRowCell) {
          addRowCell.colSpan = headerRow.cells.length;
          // Update the add row button text to include the icon
          addRowCell.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Add Exercise';
        }

        // Update the add column button text to include the icon
        const addColumnCell = document.getElementById('add-column');
        if (addColumnCell) {
          addColumnCell.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Add Workout';
        }

        // Reset table name
        tableNameInput.value = '';

        // Setup delete buttons, paste, and progress buttons
        setupDeleteButtons();
        applyPasteHandlers();
        applyProgressButtons();
        highlightPRs();
      }

      // New table button
      newTableBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to create a new table? Any unsaved changes will be lost.')) {
          localStorage.removeItem('lastWorkoutTableId');
          clearTable(false);
        }
      });

      // Load saved tables on page load and auto-restore last used table
      loadSavedTables(true);
    });
  </script>
{% endblock %}
