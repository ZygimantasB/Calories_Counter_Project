{% extends "base.html" %}
{% load static %}

{% block title %}Meal Templates{% endblock %}

{% block css_files %}
  {{ block.super }}
  <style>
    .template-card { transition: transform .15s; }
    .template-card:hover { transform: translateY(-2px); }
    .item-pill {
      display: inline-block; background: var(--bs-light,#f8f9fa);
      border: 1px solid #dee2e6; border-radius: 20px;
      padding: 2px 10px; font-size: .78rem; margin: 2px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0"><i class="fas fa-bookmark me-2 text-primary"></i>Meal Templates</h1>
    <a href="{% url 'food_tracker' %}?range=today" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left me-1"></i>Back to Food Tracker
    </a>
  </div>

  {% if messages %}
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }} alert-dismissible fade show">{{ msg }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    {% endfor %}
  {% endif %}

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="toast" class="toast align-items-center text-white border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  {% if not templates %}
  <div class="card shadow-sm border-0 text-center py-5">
    <div class="card-body">
      <i class="fas fa-bookmark fa-4x text-muted mb-3 opacity-50"></i>
      <h4 class="text-muted">No templates yet</h4>
      <p class="text-muted">Go to the Food Tracker and save a day's meals as a template.</p>
      <a href="{% url 'food_tracker' %}?range=today" class="btn btn-primary">
        <i class="fas fa-utensils me-1"></i>Go to Food Tracker
      </a>
    </div>
  </div>
  {% else %}
  <div class="row g-3">
    {% for tmpl in templates %}
    <div class="col-md-6 col-xl-4">
      <div class="card shadow-sm border-0 template-card h-100">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <span class="fw-bold">{{ tmpl.name }}</span>
          <small class="text-white-50">{{ tmpl.created_at|date:"M j, Y" }}</small>
        </div>
        <div class="card-body">
          <!-- Stats row -->
          <div class="d-flex gap-3 mb-3 small">
            <span><i class="fas fa-fire text-danger me-1"></i><strong>{{ tmpl.total_calories }}</strong> kcal</span>
            <span><i class="fas fa-drumstick-bite text-success me-1"></i><strong>{{ tmpl.total_protein }}g</strong> protein</span>
            <span><i class="fas fa-list text-muted me-1"></i><strong>{{ tmpl.item_count }}</strong> items</span>
          </div>
          <!-- Food pills -->
          <div class="mb-3">
            {% for item in tmpl.items.all %}
              <span class="item-pill">{{ item.product_name|truncatechars:30 }}</span>
            {% endfor %}
          </div>
        </div>
        <div class="card-footer bg-light d-flex gap-2 justify-content-end">
          <button class="btn btn-success btn-sm log-btn" data-id="{{ tmpl.id }}" data-name="{{ tmpl.name }}">
            <i class="fas fa-play me-1"></i>Log Now
          </button>
          <button class="btn btn-outline-danger btn-sm del-btn" data-id="{{ tmpl.id }}" data-name="{{ tmpl.name }}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

</div>

<script>
const csrfToken = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';

function showToast(msg, ok) {
  const t = document.getElementById('toast');
  const m = document.getElementById('toastMsg');
  t.classList.remove('bg-success', 'bg-danger');
  t.classList.add(ok ? 'bg-success' : 'bg-danger');
  m.textContent = msg;
  bootstrap.Toast.getOrCreateInstance(t, {delay: 3000}).show();
}

async function postJson(url) {
  const r = await fetch(url, {
    method: 'POST',
    headers: {'X-CSRFToken': csrfToken},
  });
  return r.json();
}

// Log template
document.querySelectorAll('.log-btn').forEach(btn => {
  btn.addEventListener('click', async function() {
    this.disabled = true;
    const data = await postJson(`/meal-templates/${this.dataset.id}/log/`);
    showToast(data.message || data.error, data.success);
    this.disabled = false;
  });
});

// Delete template
document.querySelectorAll('.del-btn').forEach(btn => {
  btn.addEventListener('click', async function() {
    if (!confirm(`Delete template "${this.dataset.name}"?`)) return;
    const data = await postJson(`/meal-templates/${this.dataset.id}/delete/`);
    showToast(data.message || data.error, data.success);
    if (data.success) this.closest('.col-md-6, .col-xl-4').remove();
  });
});
</script>
{% endblock %}
